<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing meta tags, title, SDK scripts -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AB Wallet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Optional: Include tinycolor library for advanced color manipulation -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> -->

    <style>
        :root {
            --bg-color: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --card-bg: #1e1e1e;
            --accent-color: #1DB954;
            --button-bg: #1DB954;
            --button-text: #ffffff;
            --input-bg: #282828;
            --border-color: #333333;
            --error-color: #f44336;
            --success-color: #4caf50;
            --warning-color: #ffa726;
            --link-color: #8774e1;
            --receive-color: var(--success-color);
            --send-color: var(--error-color);
            --swap-color: #ff9800;
            --hover-bg: rgba(255, 255, 255, 0.05);
            --modal-bg: #2a2a2a; /* Darker modal background */
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
        }

        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: var(--primary-text); overscroll-behavior: none; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }
        .app-container { flex-grow: 1; padding: 20px 15px 75px 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* --- Page Sections --- */
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Navigation --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--card-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-color); z-index: 1000; box-shadow: 0 -3px 8px rgba(0,0,0,0.3); }
        .nav-item { background: none; border: none; color: var(--secondary-text); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; padding: 8px 5px; transition: color 0.2s ease, transform 0.1s ease; flex: 1; text-align: center; height: 100%; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item:not(.active):hover { color: var(--primary-text); }
        .nav-item:active { transform: scale(0.95); }

        /* --- Common Elements --- */
        h1, h2, h3 { color: var(--primary-text); margin-bottom: 15px; }
        h1 { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 25px; }
        h2 { font-size: 18px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        h3 { font-size: 16px; color: var(--primary-text); margin-bottom: 12px; font-weight: 500; }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .balance-display { font-size: 36px; font-weight: 700; color: var(--primary-text); text-align: center; margin-bottom: 5px; }
        .balance-display span { font-size: 16px; font-weight: normal; color: var(--secondary-text); margin-left: 8px; }
        .balance-subtitle { text-align: center; color: var(--secondary-text); font-size: 14px; margin-top: 0px; margin-bottom: 25px; }
        .user-info p { margin-bottom: 10px; color: var(--secondary-text); font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .user-info strong { color: var(--primary-text); font-weight: 500; margin-right: 10px; }
        .user-info span { text-align: right; word-break: break-all; color: var(--primary-text); }
        label { display: block; margin-bottom: 8px; color: var(--secondary-text); font-size: 14px; font-weight: 500; }
        input[type="text"], input[type="number"], select { /* Select kept for fallback/consistency */ width: 100%; padding: 14px 18px; margin-bottom: 15px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text); font-size: 16px; appearance: none; -webkit-appearance: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.2); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-helper-text { font-size: 12px; color: var(--secondary-text); margin-top: -10px; margin-bottom: 15px; min-height: 16px; display: block; }
        .input-helper-text.warning { color: var(--warning-color); font-weight: 500; }
        button { background: linear-gradient(to right, var(--accent-color), #19a84c); color: var(--button-text); border: none; padding: 15px 20px; border-radius: 30px; cursor: pointer; font-size: 16px; font-weight: 600; text-align: center; width: 100%; transition: all 0.2s ease; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        button:hover { opacity: 0.9; box-shadow: 0 4px 8px rgba(0,0,0,0.25); }
        button:active { transform: scale(0.97); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; opacity: 0.6; box-shadow: none; }
        button svg { width: 20px; height: 20px; fill: currentColor; }
        .message { padding: 15px; margin: 20px 0; border-radius: 8px; text-align: center; font-size: 14px; font-weight: 500; border: 1px solid transparent; }
        .message.error { background-color: rgba(244, 67, 54, 0.15); color: var(--error-color); border-color: rgba(244, 67, 54, 0.4); }
        .message.success { background-color: rgba(76, 175, 80, 0.15); color: var(--success-color); border-color: rgba(76, 175, 80, 0.4); }
        .message.info { background-color: rgba(33, 150, 243, 0.15); color: var(--link-color); border-color: rgba(33, 150, 243, 0.4); }
        .loading-indicator { text-align: center; padding: 40px 20px; color: var(--secondary-text); display: none; font-size: 16px; }
        .loading-indicator.active { display: block; }
        .loading-indicator::before { content: ''; display: inline-block; width: 24px; height: 24px; border: 4px solid rgba(255,255,255,0.2); border-radius: 50%; border-top-color: var(--primary-text); animation: spin 1s ease-in-out infinite; margin-right: 12px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-id-display { background-color: var(--input-bg); padding: 15px 20px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; word-break: break-all; margin-top: 10px; margin-bottom: 10px; border: 1px dashed var(--border-color); cursor: pointer; text-align: center; color: var(--primary-text); font-size: 16px; transition: background-color 0.2s, border-color 0.2s; }
        .chat-id-display:hover { background-color: var(--hover-bg); border-color: var(--accent-color); }
        .copy-feedback { font-size: 13px; color: var(--success-color); text-align: center; height: 20px; margin-bottom: 15px; opacity: 0; transition: opacity 0.3s ease; font-weight: 500; }
        .copy-feedback.visible { opacity: 1; }
        .transaction-history ul { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; }
        .transaction-history li { background-color: transparent; padding: 15px 5px; margin-bottom: 0px; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--secondary-text); display: flex; justify-content: space-between; align-items: flex-start; transition: background-color 0.15s ease; }
        .transaction-history li:hover { background-color: var(--hover-bg); }
        .transaction-history li:last-child { border-bottom: none; }
        .transaction-history li .tx-details { flex-grow: 1; margin-right: 10px; display: flex; align-items: flex-start; }
        .transaction-history li .tx-type-icon { width: 22px; height: 22px; margin-right: 12px; flex-shrink: 0; margin-top: 2px; }
        .transaction-history li .tx-main-info { display: inline-block; vertical-align: top; }
        .transaction-history li span.tx-amount { font-weight: 600; color: var(--primary-text); }
        .transaction-history li span.tx-asset { font-weight: 500; color: var(--primary-text); }
        .transaction-history li span.tx-peer { font-size: 12px; display: block; margin-top: 4px; color: var(--secondary-text); word-break: break-all; }
        .transaction-history li span.tx-peer strong { color: var(--primary-text); font-weight: 500; }
        .transaction-history li span.tx-id { font-size: 11px; display: block; margin-top: 5px; color: var(--secondary-text); font-family: monospace; word-break: break-all; opacity: 0.7; cursor: pointer; transition: opacity 0.2s; }
        .transaction-history li span.tx-id:hover { opacity: 1; }
        .transaction-history li .tx-timestamp { font-size: 12px; color: var(--secondary-text); white-space: nowrap; text-align: right; padding-left: 10px; margin-top: 2px; }
        .transaction-history li.receive .tx-amount { color: var(--receive-color); }
        .transaction-history li.send .tx-amount { color: var(--send-color); }
        .transaction-history li.swap .tx-amount { color: var(--swap-color); }
        .transaction-history li.swap span.tx-amount:nth-child(2) { color: var(--receive-color); }
        #appBlocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 2000; padding: 20px; color: white; display: none; }
        #appBlocker svg { width: 72px; height: 72px; margin-bottom: 20px; }
        #appBlocker h2 { margin-top: 0; border: none; }
        #appBlocker p { margin-bottom: 20px; font-size: 16px; color: var(--secondary-text); }
        #appBlocker button { width: auto; padding: 12px 25px; }
        .token-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 5px; border-bottom: 1px solid var(--border-color); transition: background-color 0.15s ease; }
        .token-list-item:hover { background-color: var(--hover-bg); }
        .token-list-item:last-child { border-bottom: none; }
        .token-list-item .token-info { display: flex; align-items: center; }
        .token-list-item img { width: 36px; height: 36px; margin-right: 15px; border-radius: 50%; background-color: #333; border: 1px solid var(--border-color); }
        .token-list-item .token-name { font-weight: 600; color: var(--primary-text); font-size: 15px; }
        .token-list-item .token-symbol { font-size: 13px; color: var(--secondary-text); }
        .token-list-item .token-balance { text-align: right; }
        .token-list-item .balance-amount { font-weight: 600; color: var(--primary-text); font-size: 15px; }
        .token-list-item .balance-usd { font-size: 13px; color: var(--secondary-text); margin-top: 2px; }
        .swap-icon { text-align: center; margin: 15px 0; font-size: 28px; cursor: pointer; color: var(--accent-color); transform: rotate(90deg); transition: transform 0.3s ease, color 0.2s ease; }
        .swap-icon:hover { transform: rotate(270deg); color: #ffffff; }
        #swapFeeInfo { font-size: 13px; color: var(--secondary-text); text-align: center; margin-top: -5px; margin-bottom: 20px; min-height: 18px; }
        #swapRate { font-size: 14px; min-height: 20px; margin-bottom: 8px; }

        /* --- NEW: Token Selector Button Styles --- */
        .token-selector-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 18px; /* Consistent with inputs */
            margin-bottom: 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .token-selector-button:hover {
            border-color: var(--secondary-text);
        }
        .token-selector-button.selected-token-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 12px; /* Space between image and text */
        }
        .token-selector-button img {
            width: 28px; /* Slightly smaller than list */
            height: 28px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid var(--border-color);
        }
        .token-selector-button .token-name-symbol {
            line-height: 1.3;
        }
        .token-selector-button .token-name {
            font-weight: 500;
            font-size: 15px; /* Match list item */
        }
        .token-selector-button .token-symbol {
            font-size: 12px;
            color: var(--secondary-text);
        }
        .token-selector-button .select-prompt {
            color: var(--secondary-text);
            font-style: italic;
        }
        .token-selector-button .dropdown-arrow {
            margin-left: 10px;
            color: var(--secondary-text);
            font-size: 18px;
        }

        /* --- NEW: Token Selector Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Position modal at bottom */
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        .token-selector-modal {
            background-color: var(--modal-bg);
            width: 100%;
            max-width: 600px; /* Max width on larger screens */
            max-height: 75vh; /* Limit height */
            border-radius: 16px 16px 0 0; /* Rounded top corners */
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .token-selector-modal {
            transform: translateY(0);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .modal-close-button {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
        }
        .modal-close-button:hover { color: var(--primary-text); }
        .modal-search-container {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-search-input {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--primary-text);
            font-size: 15px;
            margin: 0; /* Remove default margin */
        }
        .modal-search-input:focus { outline: none; border-color: var(--accent-color); }
        .modal-token-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1; /* Take remaining space */
        }
        .modal-token-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s ease;
        }
        .modal-token-list-item:last-child { border-bottom: none; }
        .modal-token-list-item:hover { background-color: var(--hover-bg); }
        .modal-token-list-item .token-info { display: flex; align-items: center; gap: 15px; }
        .modal-token-list-item img { width: 36px; height: 36px; border-radius: 50%; background-color: #333; border: 1px solid var(--border-color); }
        .modal-token-list-item .token-name-symbol { line-height: 1.3; }
        .modal-token-list-item .token-name { font-weight: 600; color: var(--primary-text); font-size: 15px; }
        .modal-token-list-item .token-symbol { font-size: 13px; color: var(--secondary-text); }
        .modal-token-list-item .token-balance { text-align: right; }
        .modal-token-list-item .balance-amount { font-weight: 500; color: var(--primary-text); font-size: 14px; }
        .modal-token-list-item .balance-usd { font-size: 12px; color: var(--secondary-text); margin-top: 2px; }
        .modal-token-list-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-token-list-item.disabled:hover { background-color: transparent; }
        .modal-list-empty {
            padding: 30px 20px;
            text-align: center;
            color: var(--secondary-text);
            font-style: italic;
        }
         /* Swap page specific margin adjustment */
        #swapPage label[for="fromAmount"],
        #swapPage label[for="toAmount"] {
            margin-top: 10px; /* Add space above amount labels */
        }

    </style>
</head>
<body>

    <!-- Blocker -->
    <div id="appBlocker">
        <!-- ... (existing blocker content) ... -->
    </div>

    <!-- NEW: Token Selector Modal -->
    <div id="tokenSelectorOverlay" class="modal-overlay">
        <div id="tokenSelectorModal" class="token-selector-modal">
            <div class="modal-header">
                <h3 id="modalTitle">Select Token</h3>
                <button id="modalCloseBtn" class="modal-close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-search-container">
                <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="Search by name or symbol...">
            </div>
            <ul id="modalTokenList" class="modal-token-list">
                <!-- Token items will be populated here -->
                <li class="modal-list-empty">Loading tokens...</li>
            </ul>
        </div>
    </div>


    <div class="app-container">

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator active">Initializing...</div>

        <!-- Global Message Area -->
        <div id="globalMessage" class="message" style="display: none;"></div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
             <!-- ... (existing home page content, no changes needed here) ... -->
            <h1 id="welcomeMessage">Welcome!</h1>
            <div class="card">
                <h2>Total Balance</h2>
                <div class="balance-display" id="totalBalance">$0.00 <span>USD</span></div>
                <p class="balance-subtitle">Estimated value across all assets</p>
                 <div id="detailedBalances">
                     <h3>Your Assets</h3>
                     <ul id="assetList" style="list-style: none; padding: 0;">
                         <li style="color: var(--secondary-text); text-align: center; padding: 20px 0;">Loading assets...</li>
                     </ul>
                 </div>
            </div>
            <div class="card user-info">
                <h2>Account Info</h2>
                <p><strong>First Name:</strong> <span id="userFirstName">...</span></p>
                <p><strong>Last Name:</strong> <span id="userLastName">...</span></p>
                <p><strong>Username:</strong> <span id="userUsername">...</span></p>
                <p><strong>Chat ID:</strong> <span id="userChatId">...</span></p>
            </div>
             <div class="card transaction-history">
                 <h2>Recent Activity</h2>
                 <ul id="transactionList">
                    <li style="color: var(--secondary-text); text-align: center; border: none; padding: 20px 0;">Loading transactions...</li>
                 </ul>
            </div>
        </div>

        <!-- Swap Page -->
        <div id="swapPage" class="page">
            <h1>Swap Assets</h1>
            <div class="card">
                <div id="swapMessage" class="message" style="display: none;"></div>

                <label for="selectFromTokenBtn">From:</label>
                <!-- NEW: Token Selector Button -->
                <button id="selectFromTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info">
                        <span class="select-prompt">Select Token</span>
                        <!-- Populated by JS -->
                    </span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <input type="number" id="fromAmount" placeholder="0.0" min="0" step="any" inputmode="decimal">
                <p class="input-helper-text">Balance: <span id="swapFromBalance">0.00</span></p>

                <div class="swap-icon" id="swapDirectionBtn" title="Swap Tokens">⇅</div>

                <label for="selectToTokenBtn">To (Estimated):</label>
                 <!-- NEW: Token Selector Button -->
                 <button id="selectToTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info">
                         <span class="select-prompt">Select Token</span>
                        <!-- Populated by JS -->
                    </span>
                     <span class="dropdown-arrow">▼</span>
                </button>
                <input type="number" id="toAmount" placeholder="0.0" readonly style="background-color: var(--input-bg); opacity: 0.8; cursor: default;">
                 <p class="input-helper-text">Balance: <span id="swapToBalance">0.00</span></p>

                <p id="swapRate" style="text-align: center; color: var(--secondary-text); ">Select tokens to see rate</p>
                <p id="swapFeeInfo"></p> <!-- Used for Fee and Min Swap Warning -->

                <button id="swapButton" disabled>
                    <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
                    Swap
                </button>
            </div>
        </div>

        <!-- Receive Page -->
        <div id="depositPage" class="page">
             <!-- ... (existing receive page content, no changes needed here) ... -->
            <h1>Receive Assets</h1>
            <div class="card">
                 <div id="depositMessage" class="message" style="display: none;"></div>
                <p style="color: var(--secondary-text); margin-bottom: 25px; font-size: 14px; text-align: center; line-height: 1.5;">
                    Share your Telegram Chat ID below with other AB Wallet users so they can send assets directly to you.
                </p>

                <h3>Your Telegram Chat ID</h3>
                <div id="depositChatId" class="chat-id-display" title="Click to copy">Loading...</div>
                <div id="copyFeedbackDeposit" class="copy-feedback">Click the ID above to copy</div>

                 <p style="color: var(--secondary-text); font-size: 13px; margin-top: 25px; text-align: center; opacity: 0.8;">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Only use this ID for receiving assets within this AB Wallet app.
                 </p>
            </div>
        </div>

        <!-- Send Page -->
        <div id="sendPage" class="page">
            <h1>Send Assets</h1>
            <div class="card">
                 <div id="sendMessage" class="message" style="display: none;"></div>

                <label for="selectSendTokenBtn">Asset:</label>
                 <!-- NEW: Token Selector Button -->
                 <button id="selectSendTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info">
                        <span class="select-prompt">Select Asset to Send</span>
                        <!-- Populated by JS -->
                    </span>
                     <span class="dropdown-arrow">▼</span>
                </button>

                <label for="sendAmount">Amount:</label>
                <input type="number" id="sendAmount" placeholder="0.0" min="0" step="any" inputmode="decimal">
                <p class="input-helper-text">
                    <span style="float: left;" id="sendUsdValueInfo">≈ $0.00 USD</span>
                    <span style="float: right;">Available: <strong id="sendAvailableBalance" style="color: var(--primary-text);">0.00</strong></span>
                    <span style="clear: both; display: block;"></span>
                </p>

                <label for="recipientId">Recipient Telegram Chat ID:</label>
                <input type="number" id="recipientId" placeholder="Enter recipient's numeric Chat ID" inputmode="numeric">

                <p style="color: var(--secondary-text); font-size: 13px; margin: 20px 0; text-align: center; opacity: 0.8;">
                     <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Ensure the recipient ID is correct. 
                </p>

                <button id="sendButton" disabled>
                    <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    Send
                </button>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
         <!-- ... (existing nav items) ... -->
        <button class="nav-item active" data-page="homePage">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
            Home
        </button>
        <button class="nav-item" data-page="swapPage">
             <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            Swap
        </button>
        <button class="nav-item" data-page="depositPage">
             <svg viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4v2z M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            Receive
        </button>
        <button class="nav-item" data-page="sendPage">
             <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            Send
        </button>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg",
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.appspot.com",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userDbRef = null;
        let db = null;
        let userBalance = {};
        let tokenData = {};
        let userTransactions = {};
        let tg = null;
        let firebaseInitialized = false;
        let listenersAttached = false;
        const SWAP_FEE_PERCENT = 0.005; // 0.5% Swap Fee
        const MIN_SEND_USD_VALUE = 0.80; // Minimum send value in USD
        const MIN_SWAP_USD_VALUE = 0.50; // NEW: Minimum swap value in USD
        let currentModalContext = null; // NEW: Track which button opened the modal ('swap-from', 'swap-to', 'send')

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loadingIndicator');
        const globalMessage = document.getElementById('globalMessage');
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        const appContainer = document.querySelector('.app-container');
        const appBlocker = document.getElementById('appBlocker');
        // Home Page
        const welcomeMessageEl = document.getElementById('welcomeMessage');
        const totalBalanceEl = document.getElementById('totalBalance');
        const userFirstNameEl = document.getElementById('userFirstName');
        const userLastNameEl = document.getElementById('userLastName');
        const userUsernameEl = document.getElementById('userUsername');
        const userChatIdEl = document.getElementById('userChatId');
        const assetListEl = document.getElementById('assetList');
        const transactionListEl = document.getElementById('transactionList');
        // Swap Page
        const selectFromTokenBtn = document.getElementById('selectFromTokenBtn'); // NEW
        const selectToTokenBtn = document.getElementById('selectToTokenBtn'); // NEW
        const fromAmountInput = document.getElementById('fromAmount');
        const toAmountInput = document.getElementById('toAmount');
        const swapButton = document.getElementById('swapButton');
        const swapMessage = document.getElementById('swapMessage');
        const swapRateEl = document.getElementById('swapRate');
        const swapFeeInfoEl = document.getElementById('swapFeeInfo');
        const swapDirectionBtn = document.getElementById('swapDirectionBtn');
        const swapFromBalanceEl = document.getElementById('swapFromBalance');
        const swapToBalanceEl = document.getElementById('swapToBalance');
        // Receive Page
        const depositChatIdEl = document.getElementById('depositChatId');
        const depositMessage = document.getElementById('depositMessage');
        const copyFeedbackDepositEl = document.getElementById('copyFeedbackDeposit');
        // Send Page
        const selectSendTokenBtn = document.getElementById('selectSendTokenBtn'); // NEW
        const sendAmountInput = document.getElementById('sendAmount');
        const recipientIdInput = document.getElementById('recipientId');
        const sendButton = document.getElementById('sendButton');
        const sendMessage = document.getElementById('sendMessage');
        const sendAvailableBalanceEl = document.getElementById('sendAvailableBalance');
        const sendUsdValueInfoEl = document.getElementById('sendUsdValueInfo');
        // Token Selector Modal Elements (NEW)
        const tokenSelectorOverlay = document.getElementById('tokenSelectorOverlay');
        const tokenSelectorModal = document.getElementById('tokenSelectorModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalSearchInput = document.getElementById('modalSearchInput');
        const modalTokenList = document.getElementById('modalTokenList');

        // --- UTILITY FUNCTIONS ---
        // showLoading, showMessage, showGlobalMessage, formatCurrency, formatTokenAmount, triggerHapticFeedback, applyTheme, tinycolor (Keep these as they are)
        function showLoading(show, text = 'Loading...') { if (!loadingIndicator) return; loadingIndicator.textContent = text; loadingIndicator.style.display = show ? 'block' : 'none'; loadingIndicator.classList.toggle('active', show); }
        function showMessage(element, message, type = 'error', duration = 5000) { if (!element) return; element.textContent = message; element.className = `message ${type}`; element.style.display = 'block'; if (element.timeoutId) clearTimeout(element.timeoutId); if (duration > 0) { element.timeoutId = setTimeout(() => { element.style.display = 'none'; }, duration); } }
        function showGlobalMessage(message, type = 'error', duration = 5000) { showMessage(globalMessage, message, type, duration); }
        function formatCurrency(amount, decimals = 2) { const num = parseFloat(amount); return isNaN(num) ? '0.00' : num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
        function formatTokenAmount(amount, decimals = 6) { const num = parseFloat(amount); if (isNaN(num)) return '0'; let effectiveDecimals = decimals; if (num > 0) { if (num > 1000) effectiveDecimals = 2; else if (num > 1) effectiveDecimals = 4; else if (num < 0.0001) effectiveDecimals = 8; } else { effectiveDecimals = 2; } effectiveDecimals = Math.min(decimals, effectiveDecimals); return num.toLocaleString(undefined, { minimumFractionDigits: Math.min(2, effectiveDecimals) , maximumFractionDigits: effectiveDecimals }); }
        function triggerHapticFeedback(style = 'medium') { if (tg && tg.HapticFeedback) { try { if (tg.HapticFeedback.impactOccurred) tg.HapticFeedback.impactOccurred(style); else if (tg.HapticFeedback.notificationOccurred) { const type = (style === 'error' || style === 'heavy') ? 'error' : (style === 'success' || style === 'rigid') ? 'success' : 'warning'; tg.HapticFeedback.notificationOccurred(type); } } catch (e) { console.warn("Haptic feedback failed:", e); } } }
        const tinycolor = window.tinycolor || function(color) { return { darken: () => color, lighten: () => color, setAlpha: (a) => `rgba(255, 255, 255, ${a})`, toString: () => color }; };
        function applyTheme(params) { if (!params) return; const root = document.documentElement; const setProp = (prop, value) => root.style.setProperty(prop, value); const bgColor = params.bg_color || '#121212'; const textColor = params.text_color || '#ffffff'; const hintColor = params.hint_color || '#b3b3b3'; const linkColor = params.link_color || '#8774e1'; const buttonColor = params.button_color || '#1DB954'; const buttonTextColor = params.button_text_color || '#ffffff'; const secondaryBgColor = params.secondary_bg_color || '#1e1e1e'; setProp('--bg-color', bgColor); setProp('--primary-text', textColor); setProp('--secondary-text', hintColor); setProp('--link-color', linkColor); setProp('--button-bg', buttonColor); setProp('--button-text', buttonTextColor); setProp('--accent-color', buttonColor); setProp('--card-bg', secondaryBgColor); setProp('--input-bg', tinycolor(secondaryBgColor).darken(5).toString()); setProp('--border-color', tinycolor(secondaryBgColor).lighten(10).toString()); setProp('--hover-bg', tinycolor(textColor).setAlpha(0.05).toString()); setProp('--receive-color', '#4caf50'); setProp('--send-color', '#f44336'); setProp('--swap-color', '#ff9800'); setProp('--warning-color', '#ffa726'); setProp('--modal-bg', tinycolor(bgColor).lighten(5).toString()); /* Adjust modal bg based on theme */ document.body.style.backgroundColor = bgColor; document.body.style.color = textColor; if (tg && tg.setHeaderColor) try { tg.setHeaderColor(secondaryBgColor); } catch(e) { console.warn("Failed to set header color", e);} if (tg && tg.setBackgroundColor) try { tg.setBackgroundColor(bgColor); } catch(e) { console.warn("Failed to set background color", e);} }


        // --- PAGE NAVIGATION ---
        function showPage(pageId) { /* Keep existing showPage logic */
            const targetPage = document.getElementById(pageId);
             if (!targetPage) { console.error("Page not found:", pageId); showGlobalMessage(`Error: Page ${pageId} does not exist.`, 'error'); return; }
            pages.forEach(page => page.classList.remove('active'));
            targetPage.classList.add('active');
            navItems.forEach(item => { item.classList.toggle('active', item.dataset.page === pageId); });
            if (appContainer) appContainer.scrollTop = 0;
            if (swapMessage) swapMessage.style.display = 'none';
            if (depositMessage) depositMessage.style.display = 'none';
            if (sendMessage) sendMessage.style.display = 'none';
            switch(pageId) {
                 case 'homePage': updateHomePageUI(); break;
                 case 'swapPage': if (tokenData && Object.keys(tokenData).length > 0) updateSwapUI(); break;
                 case 'sendPage': if (userBalance && Object.keys(userBalance).length > 0 && tokenData) updateSendForm(); break;
                 case 'depositPage': updateDepositPageUI(); break;
             }
         }

        // --- FIREBASE FUNCTIONS ---
        // initializeFirebase, getTokenData, performSwapTransaction, performP2PTransfer (Keep mostly as is)
        function initializeFirebase() { return new Promise((resolve, reject) => { if (firebaseInitialized) { resolve(); return; } try { if (typeof firebase === 'undefined' || !firebase.app || !firebase.database) { throw new Error("Firebase SDK not loaded correctly."); } if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase Initialized"); } else { firebase.app(); console.log("Firebase Re-using existing app instance."); } db = firebase.database(); firebaseInitialized = true; resolve(); } catch (error) { console.error("Firebase Initialization Error:", error); showGlobalMessage("Error connecting to database services. Please try again later.", "error", 0); reject(error); } }); }
        function getTokenData() { if (!db) return Promise.reject("Database not available for fetching token data."); const tokensRef = db.ref('tokens'); return tokensRef.once('value') .then(snapshot => { tokenData = snapshot.val() || {}; if (Object.keys(tokenData).length === 0) { console.warn("No token data found in Firebase under /tokens path."); if (!tokenData.USDT) { tokenData.USDT = { name: "Tether USD", priceUSD: 1.00, logoUrl: "https://via.placeholder.com/32/26A17B/ffffff?text=USDT" }; } showGlobalMessage("Could not load all token price information.", "info", 5000); } else { if (tokenData.USDT) { tokenData.USDT.priceUSD = 1.00; } else { tokenData.USDT = { name: "Tether USD", priceUSD: 1.00, logoUrl: "https://via.placeholder.com/32/26A17B/ffffff?text=USDT" }; } console.log("Token data loaded:", tokenData); } return tokenData; }) .catch(error => { console.error("Error fetching token data:", error); showGlobalMessage("Failed to load crucial token information. Prices may be incorrect.", "error", 0); tokenData = { USDT: { name: "Tether USD", priceUSD: 1.00, logoUrl: "https://via.placeholder.com/32/26A17B/ffffff?text=USDT" } }; return tokenData; }); }
        async function performSwapTransaction(userId, updates, txRecord) { if (!db || !userId) return Promise.reject("Database or UserID not available for swap."); userId = String(userId); const multiPathUpdate = {}; for (const asset in updates) { const updateValue = parseFloat(updates[asset]); if (isNaN(updateValue)) { throw new Error(`Invalid update value for asset ${asset}: ${updates[asset]}`); } multiPathUpdate[`/users/${userId}/balances/${asset}`] = firebase.database.ServerValue.increment(updateValue); } const txRef = db.ref(`users/${userId}/transactions`).push(); multiPathUpdate[`/users/${userId}/transactions/${txRef.key}`] = { ...txRecord, timestamp: firebase.database.ServerValue.TIMESTAMP }; console.log("Attempting Atomic Swap Update:", JSON.stringify(multiPathUpdate, null, 2)); return db.ref().update(multiPathUpdate); }
        async function performP2PTransfer(senderId, recipientId, asset, amount) { senderId = String(senderId); recipientId = String(recipientId); amount = parseFloat(amount); if (!db || !senderId || !recipientId || !asset || isNaN(amount) || amount <= 0) { return Promise.reject("Invalid parameters for transfer."); } if (senderId === recipientId) { return Promise.reject("Cannot send assets to yourself."); } const recipientRef = db.ref(`users/${recipientId}`); const recipientSnapshot = await recipientRef.once('value'); if (!recipientSnapshot.exists()) { const error = new Error(`Recipient with Chat ID ${recipientId} not found or has not used the wallet yet.`); error.code = "RECIPIENT_NOT_FOUND"; throw error; } const senderTxRef = db.ref(`users/${senderId}/transactions`).push(); const recipientTxRef = db.ref(`users/${recipientId}/transactions`).push(); const multiPathUpdate = {}; multiPathUpdate[`/users/${senderId}/balances/${asset}`] = firebase.database.ServerValue.increment(-amount); multiPathUpdate[`/users/${recipientId}/balances/${asset}`] = firebase.database.ServerValue.increment(amount); multiPathUpdate[`/users/${senderId}/transactions/${senderTxRef.key}`] = { type: "send", asset: asset, amount: amount, toUserId: recipientId, status: "completed", timestamp: firebase.database.ServerValue.TIMESTAMP, recipientTxKey: recipientTxRef.key }; multiPathUpdate[`/users/${recipientId}/transactions/${recipientTxRef.key}`] = { type: "receive", asset: asset, amount: amount, fromUserId: senderId, status: "completed", timestamp: firebase.database.ServerValue.TIMESTAMP, senderTxKey: senderTxRef.key }; console.log("Attempting Atomic P2P Update:", JSON.stringify(multiPathUpdate, null, 2)); return db.ref().update(multiPathUpdate); }

        // Modify getUserDataRealtime for initial balance
        function getUserDataRealtime(userId) {
            if (!db || !userId) return Promise.reject("Database or UserID not available for real-time updates.");
            userDbRef = db.ref(`users/${userId}`);
            return new Promise((resolve, reject) => {
                let initialDataLoaded = false;
                userDbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    console.log(`Data received for user ${userId}:`, data ? 'Exists' : 'Does not exist');
                    if (data) {
                        userBalance = data.balances || {};
                        userTransactions = data.transactions || {};
                        updateHomePageUI();
                        updateSwapUI();
                        updateSendForm();
                        // populateSendTokenSelector(); // Removed, handled by modal logic now
                        if (!initialDataLoaded) { initialDataLoaded = true; resolve(data); }
                    } else if (currentUser && userId === String(currentUser.id) && !snapshot.exists() && !initialDataLoaded) {
                         console.log("User not found in DB, creating entry with initial balance...");
                         const { id, first_name, last_name, username } = currentUser;
                         const initialUserData = {
                             chatId: String(id),
                             firstName: first_name || '', lastName: last_name || '', username: username || 'N/A',
                             joinedAt: firebase.database.ServerValue.TIMESTAMP,
                             balances: { USDT: 0.1 }, // NEW: Initial balance 0.1 USDT
                             transactions: {}
                         };
                         userDbRef.set(initialUserData)
                            .then(() => {
                                console.log("Initial user data created successfully.");
                                userBalance = initialUserData.balances;
                                userTransactions = initialUserData.transactions;
                                updateHomePageUI();
                                // populateSendTokenSelector(); // Removed
                                updateSendForm();
                                if (!initialDataLoaded) { initialDataLoaded = true; resolve(initialUserData); }
                            })
                            .catch(err => {
                                console.error("Failed to create initial user data:", err);
                                showGlobalMessage("Error setting up your wallet account.", "error", 0);
                                if (!initialDataLoaded) reject(err);
                            });
                    } else if (!initialDataLoaded && !snapshot.exists()) {
                         console.warn(`User data for ID ${userId} not found, and not creating.`);
                         if (!initialDataLoaded) resolve(null);
                    }
                }, (error) => {
                    console.error(`Firebase Read Error for user ${userId}:`, error);
                    showGlobalMessage("Database connection error. Displayed data might be outdated.", "error", 5000);
                    triggerHapticFeedback('error');
                    if (!initialDataLoaded) reject(error);
                });
            });
        }

        // --- UI UPDATE FUNCTIONS ---
        // updateHomePageUI, updateTransactionHistory (Keep mostly as is)
        function updateHomePageUI() { if (!currentUser || !welcomeMessageEl) return; welcomeMessageEl.textContent = `Welcome, ${currentUser.first_name || 'User'}!`; userFirstNameEl.textContent = currentUser.first_name || '-'; userLastNameEl.textContent = currentUser.last_name || '-'; userUsernameEl.textContent = currentUser.username ? `@${currentUser.username}` : '(No username)'; userChatIdEl.textContent = currentUser.id || 'N/A'; let totalUsdValue = 0; assetListEl.innerHTML = ''; const sortedBalances = Object.entries(userBalance) .map(([asset, balance]) => ({ asset, balance: parseFloat(balance || 0), tokenInfo: tokenData[asset], priceUsd: parseFloat(tokenData[asset]?.priceUSD || (asset === 'USDT' ? 1 : 0)) })) .filter(item => item.balance > 0.000001 || item.asset === 'USDT') .map(item => ({ ...item, usdValue: item.balance * item.priceUsd })) .sort((a, b) => { if (b.usdValue !== a.usdValue) return b.usdValue - a.usdValue; const nameA = a.tokenInfo?.name || a.asset; const nameB = b.tokenInfo?.name || b.asset; return nameA.localeCompare(nameB); }); if (sortedBalances.length === 0) { assetListEl.innerHTML = '<li style="color: var(--secondary-text); text-align: center; padding: 20px 0;">You have no assets yet.</li>'; } else { sortedBalances.forEach(item => { totalUsdValue += item.usdValue; const li = document.createElement('li'); li.className = 'token-list-item'; li.innerHTML = ` <div class="token-info"> <img src="${item.tokenInfo?.logoUrl || `https://via.placeholder.com/36/333333/ffffff?text=${item.asset.substring(0,1)}`}" alt="${item.asset}"> <div> <div class="token-name">${item.tokenInfo?.name || item.asset}</div> <div class="token-symbol">${item.asset}</div> </div> </div> <div class="token-balance"> <div class="balance-amount">${formatTokenAmount(item.balance, 8)}</div> ${item.usdValue > 0.01 ? `<div class="balance-usd">≈ $${formatCurrency(item.usdValue)}</div>` : ''} </div> `; assetListEl.appendChild(li); }); } totalBalanceEl.innerHTML = `$${formatCurrency(totalUsdValue)} <span>USD</span>`; updateTransactionHistory(); }
        function updateTransactionHistory() { if (!transactionListEl) return; transactionListEl.innerHTML = ''; const txArray = Object.entries(userTransactions || {}) .map(([key, value]) => ({ id: key, ...value })) .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); if (txArray.length === 0) { transactionListEl.innerHTML = '<li style="color: var(--secondary-text); text-align: center; border: none; padding: 20px 0;">No transaction history.</li>'; return; } txArray.slice(0, 30).forEach(tx => { const li = document.createElement('li'); li.classList.add(tx.type || 'unknown'); let iconSvg = ''; let mainInfoHtml = ''; let peerInfoHtml = ''; const amountFormatted = formatTokenAmount(tx.amount || tx.fromAmount || 0, 8); const assetSymbol = tx.asset || tx.fromAsset || '?'; const toAmountFormatted = tx.toAmount ? formatTokenAmount(tx.toAmount, 8) : ''; const toAssetSymbol = tx.toAsset || ''; switch (tx.type) { case 'receive': iconSvg = `<svg class="tx-type-icon" style="color: var(--receive-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M11 15h2v-4h4v-2h-4V5h-2v4H7v2h4v4zm1-13C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>`; mainInfoHtml = `Received <span class="tx-amount">${amountFormatted}</span> <span class="tx-asset">${assetSymbol}</span>`; peerInfoHtml = `<span class="tx-peer">From: <strong>${tx.fromUserId || 'Unknown Source'}</strong></span>`; break; case 'send': iconSvg = `<svg class="tx-type-icon" style="color: var(--send-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.7-.3.7-1.2 0-1.5L3.4 2.1c-.6-.3-1.3.1-1.3.8l.9 6.5c0 .5.5.9 1 .9h6.4c.4 0 .6.5.3.8l-2.6 2.1c-.4.3-.4.9 0 1.2l2.6 2.1c.3.3.1.8-.3.8H4c-.5 0-1 .4-1 .9l-.9 6.5c0 .6.7 1.1 1.3.8z"></path></svg>`; mainInfoHtml = `Sent <span class="tx-amount">${amountFormatted}</span> <span class="tx-asset">${assetSymbol}</span>`; peerInfoHtml = `<span class="tx-peer">To: <strong>${tx.toUserId || 'Unknown Destination'}</strong></span>`; break; case 'swap': iconSvg = `<svg class="tx-type-icon" style="color: var(--swap-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>`; mainInfoHtml = `Swapped <span class="tx-amount">${amountFormatted} ${assetSymbol}</span> for <span class="tx-amount">${toAmountFormatted} ${toAssetSymbol}</span>`; if (tx.effectiveRate && tx.fromAsset && tx.toAsset) { peerInfoHtml = `<span class="tx-peer">Rate: ≈ ${formatTokenAmount(tx.effectiveRate, 5)} ${tx.toAsset}/${tx.fromAsset}</span>`; } else { peerInfoHtml = `<span class="tx-peer">Swap processed</span>`; } break; default: iconSvg = `<svg class="tx-type-icon" style="color: var(--secondary-text);" viewBox="0 0 24 24" fill="currentColor"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/></svg>`; mainInfoHtml = `System: <span class="tx-amount">${amountFormatted}</span> <span class="tx-asset">${assetSymbol}</span>`; peerInfoHtml = `<span class="tx-peer">Type: ${tx.type || 'Unknown'}</span>`; } const timestampStr = tx.timestamp ? new Date(tx.timestamp).toLocaleString([], { day: '2-digit', month: 'short', hour: '2-digit', minute:'2-digit', hour12: false }) : 'Pending...'; const txIdHtml = tx.id ? `<span class="tx-id" title="Click to copy Tx ID: ${tx.id}" onclick="copyTextToClipboard('${tx.id}', 'Transaction ID')">TxID: ${tx.id.substring(0, 6)}...${tx.id.substring(tx.id.length - 4)}</span>` : ''; li.innerHTML = ` <div class="tx-details"> ${iconSvg} <div class="tx-main-info"> ${mainInfoHtml} ${peerInfoHtml} ${txIdHtml} </div> </div> <div class="tx-timestamp">${timestampStr}</div> `; transactionListEl.appendChild(li); }); }
        // populateTokenSelectors, populateSendTokenSelector (Removed as modal handles selection)

        // --- NEW: Token Modal Functions ---
        function openTokenSelector(context) {
            currentModalContext = context; // 'swap-from', 'swap-to', 'send'
            modalSearchInput.value = ''; // Clear search on open
            populateTokenList(); // Populate based on context
            modalTitle.textContent = context === 'send' ? 'Select Asset to Send' : 'Select Token';
            tokenSelectorOverlay.classList.add('active');
            // Focus input after animation starts
            setTimeout(() => modalSearchInput.focus(), 50);
            // Prevent body scrolling while modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeTokenSelector() {
            tokenSelectorOverlay.classList.remove('active');
             // Restore body scrolling after animation
            setTimeout(() => document.body.style.overflow = '', 300);
        }

        function populateTokenList() {
            modalTokenList.innerHTML = ''; // Clear previous list
            const searchTerm = modalSearchInput.value.toLowerCase().trim();

            // Determine which tokens to show based on context
            let tokensToShow = Object.entries(tokenData);

            // For 'send', filter by assets the user actually owns > 0
            if (currentModalContext === 'send') {
                tokensToShow = tokensToShow.filter(([symbol, data]) => {
                    const balance = parseFloat(userBalance[symbol] || 0);
                    return balance > 0.0000001; // Only show assets with some balance
                });
            }

            // Filter by search term (name or symbol)
            if (searchTerm) {
                 tokensToShow = tokensToShow.filter(([symbol, data]) =>
                     symbol.toLowerCase().includes(searchTerm) ||
                     (data.name || '').toLowerCase().includes(searchTerm)
                 );
             }

             // Sort tokens alphabetically by name
             tokensToShow.sort(([, dataA], [, dataB]) => (dataA.name || '').localeCompare(dataB.name || ''));

            if (tokensToShow.length === 0) {
                modalTokenList.innerHTML = `<li class="modal-list-empty">${searchTerm ? 'No matching tokens found.' : 'No tokens available.'}</li>`;
                return;
            }

            // Get currently selected tokens to disable them in the list if needed
            const selectedFromToken = selectFromTokenBtn.dataset.token;
            const selectedToToken = selectToTokenBtn.dataset.token;
            const selectedSendToken = selectSendTokenBtn.dataset.token;

            tokensToShow.forEach(([symbol, data]) => {
                const li = document.createElement('li');
                li.className = 'modal-token-list-item';
                li.dataset.symbol = symbol;

                const balance = parseFloat(userBalance[symbol] || 0);
                const priceUsd = parseFloat(data.priceUSD || (symbol === 'USDT' ? 1 : 0));
                const balanceUsdValue = balance * priceUsd;

                let balanceHtml = '';
                // Show balance only for the 'send' context
                if (currentModalContext === 'send') {
                     balanceHtml = `
                         <div class="token-balance">
                             <div class="balance-amount">${formatTokenAmount(balance, 8)}</div>
                             ${balanceUsdValue > 0.01 ? `<div class="balance-usd">≈ $${formatCurrency(balanceUsdValue)}</div>` : ''}
                         </div>
                     `;
                 }

                li.innerHTML = `
                    <div class="token-info">
                        <img src="${data.logoUrl || `https://via.placeholder.com/36/333333/ffffff?text=${symbol.substring(0,1)}`}" alt="${symbol}">
                        <div class="token-name-symbol">
                            <div class="token-name">${data.name || symbol}</div>
                            <div class="token-symbol">${symbol}</div>
                        </div>
                    </div>
                    ${balanceHtml}
                `;

                 // Disable selection if this token is already selected in the *other* swap slot
                 let isDisabled = false;
                 if (currentModalContext === 'swap-from' && symbol === selectedToToken) isDisabled = true;
                 if (currentModalContext === 'swap-to' && symbol === selectedFromToken) isDisabled = true;
                 // Also disable if the token is already selected for the current slot (redundant selection)
                 if (currentModalContext === 'swap-from' && symbol === selectedFromToken) isDisabled = true;
                 if (currentModalContext === 'swap-to' && symbol === selectedToToken) isDisabled = true;
                 if (currentModalContext === 'send' && symbol === selectedSendToken) isDisabled = true;


                 if (isDisabled) {
                    li.classList.add('disabled');
                    // Optionally add a title explaining why it's disabled
                    li.title = `Token already selected ${currentModalContext === 'send' ? '' : 'in other slot'}`;
                 } else {
                    li.addEventListener('click', () => handleTokenSelection(symbol));
                 }

                modalTokenList.appendChild(li);
            });
        }

        function handleTokenSelection(symbol) {
            const token = tokenData[symbol];
            if (!token) return;

            // Determine which button to update
            let targetButton;
            if (currentModalContext === 'swap-from') targetButton = selectFromTokenBtn;
            else if (currentModalContext === 'swap-to') targetButton = selectToTokenBtn;
            else if (currentModalContext === 'send') targetButton = selectSendTokenBtn;
            else return; // Should not happen

            // Update the button appearance and data attribute
            targetButton.dataset.token = symbol;
            const infoSpan = targetButton.querySelector('.selected-token-info');
            infoSpan.innerHTML = `
                 <img src="${token.logoUrl || `https://via.placeholder.com/36/333333/ffffff?text=${symbol.substring(0,1)}`}" alt="${symbol}">
                 <div class="token-name-symbol">
                     <div class="token-name">${token.name || symbol}</div>
                     <div class="token-symbol">${symbol}</div>
                 </div>
             `;

            closeTokenSelector();
            triggerHapticFeedback('light');

            // Trigger UI update for the relevant page
            if (currentModalContext.startsWith('swap')) {
                updateSwapUI();
            } else if (currentModalContext === 'send') {
                updateSendForm();
            }
        }


        // --- UPDATE UI Functions (Modified) ---

        function updateSwapUI() {
            // Get selected tokens from button data attributes
            const fromAsset = selectFromTokenBtn.dataset.token;
            const toAsset = selectToTokenBtn.dataset.token;

            // Ensure elements and data are ready
             if (!fromAmountInput || !toAmountInput || !swapFromBalanceEl || !swapToBalanceEl || !swapButton || !tokenData) return;

            const fromAmount = Math.max(0, parseFloat(fromAmountInput.value || 0));
            const fromBalance = parseFloat(userBalance[fromAsset] || 0);
            const toBalance = parseFloat(userBalance[toAsset] || 0);

            // Update balance displays (only if assets are selected)
            swapFromBalanceEl.textContent = fromAsset ? `${formatTokenAmount(fromBalance, 8)} ${fromAsset}` : '0.00';
            swapToBalanceEl.textContent = toAsset ? `${formatTokenAmount(toBalance, 8)} ${toAsset}` : '0.00';

            updateSwapRateAndToAmount(); // Handles rate, fee, toAmount, min swap warning

            // --- Validation for Swap Button ---
            const calculatedToAmount = parseFloat(toAmountInput.value || 0);
            const hasSufficientBalance = fromBalance >= fromAmount;
            const isValidAmount = fromAmount > 0;
            const areTokensSelected = fromAsset && toAsset;
            const areTokensDifferent = fromAsset !== toAsset;
            const isRateAvailable = calculatedToAmount > 0; // Rate is available if we could calculate a positive output

            // Minimum Swap Value Check
            let meetsMinValue = true; // Assume true initially
            let minSwapWarning = '';
            let fromAmountUsdValue = 0;
            if (isValidAmount && fromAsset && tokenData[fromAsset]) {
                const priceUsd = parseFloat(tokenData[fromAsset].priceUSD || 0);
                if (priceUsd > 0) {
                    fromAmountUsdValue = fromAmount * priceUsd;
                    if (fromAmountUsdValue < MIN_SWAP_USD_VALUE) {
                        meetsMinValue = false;
                         minSwapWarning = `Minimum swap value is ≈ $${formatCurrency(MIN_SWAP_USD_VALUE)}.`;
                    }
                }
            }

            // Combine Fee and Min Value Info
            const feePercentDisplay = (SWAP_FEE_PERCENT * 100).toFixed(2) + '%';
            let feeInfoText = `Fee: ${feePercentDisplay}. `;
            if (!meetsMinValue) {
                feeInfoText += minSwapWarning;
                swapFeeInfoEl.classList.add('warning');
            } else {
                 swapFeeInfoEl.classList.remove('warning');
            }
            swapFeeInfoEl.textContent = feeInfoText; // Update fee/min swap info

            const canSwap = areTokensSelected &&
                            areTokensDifferent &&
                            isValidAmount &&
                            hasSufficientBalance &&
                            isRateAvailable &&
                            meetsMinValue; // Add min value check

            swapButton.disabled = !canSwap;

             // Provide feedback if balance is the issue (or min value)
            if (areTokensSelected && areTokensDifferent && isValidAmount) {
                if (!hasSufficientBalance) {
                    showMessage(swapMessage, `Insufficient ${fromAsset} balance`, 'error', 4000);
                    triggerHapticFeedback('error');
                } else if (!meetsMinValue) {
                    // Don't show swapMessage, warning is in swapFeeInfoEl
                } else if (swapMessage.style.display !== 'none' && (swapMessage.textContent.includes('Insufficient') || swapMessage.textContent.includes('Minimum'))) {
                    swapMessage.style.display = 'none'; // Hide previous error messages if resolved
                }
            } else if (swapMessage.style.display !== 'none' && swapMessage.textContent.includes('Insufficient')) {
                 swapMessage.style.display = 'none'; // Hide old insufficient balance message
            }
        }

         function updateSwapRateAndToAmount() {
            // Get current selections and amount
            const fromAsset = selectFromTokenBtn.dataset.token;
            const toAsset = selectToTokenBtn.dataset.token;
            const fromAmount = parseFloat(fromAmountInput.value || 0);

            // Reset outputs initially
            toAmountInput.value = '';
            swapRateEl.textContent = 'Enter amount and select tokens';
            swapFeeInfoEl.textContent = ''; // Clear fee/min info

            // Basic validation
            if (!fromAsset || !toAsset || !tokenData[fromAsset] || !tokenData[toAsset]) {
                swapRateEl.textContent = 'Select valid tokens';
                return;
            }
            if (fromAsset === toAsset) {
                 swapRateEl.textContent = 'Cannot swap the same token'; return;
            }

            // Get prices
            const fromPrice = parseFloat(tokenData[fromAsset].priceUSD || 0);
            const toPrice = parseFloat(tokenData[toAsset].priceUSD || 0);

             if (fromPrice <= 0 || toPrice <= 0) {
                 swapRateEl.textContent = 'Price information unavailable';
                 swapFeeInfoEl.textContent = 'Cannot calculate swap.';
                 toAmountInput.value = '0'; // Set to 0 if prices missing
                 return;
             }

             // Calculate base rate before fee
            const baseRate = fromPrice / toPrice;
            swapRateEl.textContent = `1 ${fromAsset} ≈ ${formatTokenAmount(baseRate, 5)} ${toAsset}`; // Show rate even if amount is 0


             // Calculate swap output only if amount is valid
            if (isNaN(fromAmount) || fromAmount <= 0) {
                 swapFeeInfoEl.textContent = `Fee: ${(SWAP_FEE_PERCENT * 100).toFixed(2)}%`; // Show base fee info
                return;
            }

            // Calculate fee and final amount
            const fromUsdValue = fromAmount * fromPrice;
            const toAmountBeforeFee = fromUsdValue / toPrice;
            const feeAmount = toAmountBeforeFee * SWAP_FEE_PERCENT;
            const calculatedToAmount = toAmountBeforeFee - feeAmount;

            // Display the calculated 'to' amount (after fee)
             toAmountInput.value = (isNaN(calculatedToAmount) || calculatedToAmount < 0) ? '0' : formatTokenAmount(calculatedToAmount, 8);

             // Update fee info text (min value check happens in updateSwapUI)
             swapFeeInfoEl.textContent = `Fee: ${formatTokenAmount(feeAmount, 6)} ${toAsset} (${(SWAP_FEE_PERCENT * 100).toFixed(2)}%)`;
        }


        function updateSendForm() {
             // Get selected token from button data attribute
             const selectedAsset = selectSendTokenBtn.dataset.token;

             if (!sendAmountInput || !recipientIdInput || !sendAvailableBalanceEl || !sendUsdValueInfoEl || !sendButton || !tokenData || !currentUser) return;

             const availableBalance = parseFloat(userBalance[selectedAsset] || 0);
             const sendAmount = Math.max(0, parseFloat(sendAmountInput.value || 0));
             const recipientId = recipientIdInput.value.trim();

             // Update Available Balance Display (only if asset selected)
             sendAvailableBalanceEl.textContent = selectedAsset ? `${formatTokenAmount(availableBalance, 8)} ${selectedAsset}` : '0.00';

             // Calculate and Display USD Value
             let usdValue = 0;
             let priceUsd = 0;
             let usdValueText = '≈ $0.00 USD';
             let isBelowMin = false;
             sendUsdValueInfoEl.classList.remove('warning');

             if (selectedAsset && tokenData[selectedAsset]) {
                 priceUsd = parseFloat(tokenData[selectedAsset].priceUSD || 0);
                 if (priceUsd > 0) {
                     usdValue = sendAmount * priceUsd;
                     usdValueText = `≈ $${formatCurrency(usdValue)} USD`;
                     if (sendAmount > 0 && usdValue < MIN_SEND_USD_VALUE) {
                         isBelowMin = true;
                         usdValueText += ` (Min $${formatCurrency(MIN_SEND_USD_VALUE)})`;
                         sendUsdValueInfoEl.classList.add('warning');
                     }
                 } else if (sendAmount > 0) {
                     usdValueText = `USD value unavailable`;
                     sendUsdValueInfoEl.classList.add('warning');
                 }
             } else if (sendAmount > 0) {
                usdValueText = `Select asset first`;
             }

             sendUsdValueInfoEl.textContent = usdValueText;

             // --- Validation for Send Button ---
             const isValidRecipient = /^\d+$/.test(recipientId) && recipientId.length > 3;
             const isNotSendingToSelf = recipientId !== String(currentUser.id);
             const hasSufficientBalance = availableBalance >= sendAmount;
             const isValidAmount = sendAmount > 0;
             const meetsMinValue = !isBelowMin || sendAmount === 0;
             const canSend = selectedAsset &&
                             isValidAmount &&
                             isValidRecipient &&
                             isNotSendingToSelf &&
                             hasSufficientBalance &&
                             meetsMinValue &&
                             priceUsd > 0;

             sendButton.disabled = !canSend;

             // --- Clear specific error messages if conditions resolved ---
             if (sendMessage.style.display !== 'none' && sendMessage.classList.contains('error')) {
                 if (sendMessage.textContent.includes("Insufficient") && hasSufficientBalance) sendMessage.style.display = 'none';
                 if (sendMessage.textContent.includes("Minimum") && meetsMinValue) sendMessage.style.display = 'none';
                 if (sendMessage.textContent.includes("Recipient ID") && isValidRecipient && isNotSendingToSelf) sendMessage.style.display = 'none';
                 if (sendMessage.textContent.includes("Select asset") && selectedAsset) sendMessage.style.display = 'none';
             }
        }

        function updateDepositPageUI() { /* Keep existing logic */
             if (currentUser && depositChatIdEl) { depositChatIdEl.textContent = currentUser.id || 'Error: ID Missing'; } else if (depositChatIdEl) { depositChatIdEl.textContent = 'Loading User Info...'; } if (copyFeedbackDepositEl) { copyFeedbackDepositEl.classList.remove('visible'); copyFeedbackDepositEl.textContent = 'Click the ID above to copy'; }
        }
        function copyTextToClipboard(text, contentType = 'Chat ID') { /* Keep existing logic */
            if (!text) { showGlobalMessage(`No ${contentType} to copy.`, 'info'); return; } if (!navigator.clipboard) { showGlobalMessage('Clipboard copy not supported by your browser/context.', 'error'); return; } navigator.clipboard.writeText(text).then(() => { if (contentType === 'Chat ID' && copyFeedbackDepositEl) { copyFeedbackDepositEl.textContent = `${contentType} Copied!`; copyFeedbackDepositEl.classList.add('visible'); setTimeout(() => { copyFeedbackDepositEl.classList.remove('visible'); copyFeedbackDepositEl.textContent = 'Click the ID above to copy'; }, 2500); } else { showGlobalMessage(`${contentType} copied to clipboard!`, 'success', 2000); } triggerHapticFeedback('success'); }).catch(err => { console.error(`Failed to copy ${contentType}: `, err); showGlobalMessage(`Failed to copy ${contentType}.`, 'error'); triggerHapticFeedback('error'); });
        }


        // --- ACTION HANDLERS (Modified) ---
        async function handleSwap() {
             // Get selected tokens from button data attributes
             const fromAsset = selectFromTokenBtn.dataset.token;
             const toAsset = selectToTokenBtn.dataset.token;
             const fromAmount = parseFloat(fromAmountInput.value);
             const toAmount = parseFloat(toAmountInput.value); // Get the calculated 'to' amount from input

             // --- Re-Validate Before Execution ---
             if (!currentUser || !fromAsset || !toAsset || fromAsset === toAsset || isNaN(fromAmount) || fromAmount <= 0 || isNaN(toAmount) || toAmount <= 0) {
                 showMessage(swapMessage, "Invalid swap details. Please check amounts and tokens.", "error"); return;
             }
             const fromBalance = parseFloat(userBalance[fromAsset] || 0);
             if (fromBalance < fromAmount) {
                 showMessage(swapMessage, `Insufficient ${fromAsset} balance for this swap.`, "error"); return;
             }
             const fromPrice = parseFloat(tokenData[fromAsset]?.priceUSD || 0);
             const toPrice = parseFloat(tokenData[toAsset]?.priceUSD || 0);
              if (fromPrice <= 0 || toPrice <= 0) {
                  showMessage(swapMessage, "Cannot perform swap due to missing price information.", "error"); return;
              }
             // Minimum Swap Value Check
              const fromAmountUsdValue = fromAmount * fromPrice;
               if (fromAmountUsdValue < MIN_SWAP_USD_VALUE) {
                    showMessage(swapMessage, `Swap amount is below the minimum requirement of ≈ $${formatCurrency(MIN_SWAP_USD_VALUE)}.`, "error", 5000); return;
               }
             // --- End Validation ---

             showLoading(true, 'Processing Swap...');
             swapButton.disabled = true;
             triggerHapticFeedback('light');

             try {
                 // Recalculate final amounts just before sending to be sure
                 const baseRate = fromPrice / toPrice;
                 const fromUsdValueRecalc = fromAmount * fromPrice;
                 const toAmountBeforeFeeRecalc = fromUsdValueRecalc / toPrice;
                 const feeAmountRecalc = toAmountBeforeFeeRecalc * SWAP_FEE_PERCENT;
                 const finalToAmountRecalc = toAmountBeforeFeeRecalc - feeAmountRecalc;
                 const effectiveRateRecalc = (fromAmount > 0) ? finalToAmountRecalc / fromAmount : 0;

                 const balanceUpdates = {
                     [fromAsset]: -fromAmount,
                     [toAsset]: finalToAmountRecalc // Use recalculated final amount
                 };
                 const txRecord = {
                     type: "swap", fromAsset: fromAsset, fromAmount: fromAmount,
                     toAsset: toAsset, toAmount: finalToAmountRecalc,
                     rate: baseRate, effectiveRate: effectiveRateRecalc,
                     fee: feeAmountRecalc, feeAsset: toAsset, status: "completed"
                 };

                 await performSwapTransaction(currentUser.id, balanceUpdates, txRecord);

                 showMessage(swapMessage, `Successfully swapped ${formatTokenAmount(fromAmount)} ${fromAsset} for ~${formatTokenAmount(finalToAmountRecalc)} ${toAsset}!`, "success", 5000);
                 triggerHapticFeedback('success');
                 fromAmountInput.value = ''; // Clear input field
                 // updateSwapUI will be called by the listener

             } catch (error) {
                 console.error("Swap Transaction Error:", error);
                 showMessage(swapMessage, `Swap failed: ${error.message || "Please try again."}`, "error");
                 triggerHapticFeedback('error');
             } finally {
                 showLoading(false);
                 // updateSwapUI(); // Listener handles this
             }
         }

        async function handleSend() {
             // Get selected token from button data attribute
             const asset = selectSendTokenBtn.dataset.token;
             const amount = parseFloat(sendAmountInput.value);
             const recipientId = recipientIdInput.value.trim();

             // --- Re-Validate Before Execution ---
             if (!currentUser || !asset || isNaN(amount) || amount <= 0 || !recipientId) {
                 showMessage(sendMessage, "Please select an asset and fill all fields correctly.", "error"); return;
             }
             if (!/^\d+$/.test(recipientId) || recipientId.length <= 3) {
                  showMessage(sendMessage, "Invalid Recipient Telegram Chat ID format.", "error"); return;
             }
             const senderId = String(currentUser.id);
              if (recipientId === senderId) {
                 showMessage(sendMessage, "Sending assets to yourself is not allowed.", "error"); return;
             }
             const balance = parseFloat(userBalance[asset] || 0);
             if (balance < amount) {
                 showMessage(sendMessage, `Insufficient balance to send ${formatTokenAmount(amount)} ${asset}.`, "error"); return;
             }
             const priceUsd = parseFloat(tokenData[asset]?.priceUSD || 0);
             if (priceUsd <= 0) {
                 showMessage(sendMessage, `Cannot send ${asset} as price information is currently unavailable.`, "error"); return;
             }
             const usdValue = amount * priceUsd;
             if (usdValue < MIN_SEND_USD_VALUE) {
                 showMessage(sendMessage, `Send amount is below the minimum requirement of $${formatCurrency(MIN_SEND_USD_VALUE)}. Current value: $${formatCurrency(usdValue)}.`, "error", 6000); return;
             }
             // --- End Validation ---

             showLoading(true, 'Processing Transfer...');
             sendButton.disabled = true;
             triggerHapticFeedback('light');

             try {
                 await performP2PTransfer(senderId, recipientId, asset, amount);
                 showMessage(sendMessage, `Successfully sent ${formatTokenAmount(amount)} ${asset} to user ${recipientId}.`, "success", 5000);
                 triggerHapticFeedback('success');
                 sendAmountInput.value = '';
                 recipientIdInput.value = '';
                 // Reset selected token button appearance
                 const sendButtonInfo = selectSendTokenBtn.querySelector('.selected-token-info');
                 sendButtonInfo.innerHTML = `<span class="select-prompt">Select Asset to Send</span>`;
                 selectSendTokenBtn.dataset.token = '';
                 updateSendForm(); // Update display after clearing

             } catch (error) {
                 console.error("Send Transaction Error:", error);
                 triggerHapticFeedback('error');
                 if (error.code === "RECIPIENT_NOT_FOUND") {
                     showMessage(sendMessage, error.message, "error", 6000);
                 } else if (error.message.includes("permission_denied")) {
                      showMessage(sendMessage, `Transfer failed due to a permission issue. Please contact support.`, "error", 6000);
                 } else {
                      showMessage(sendMessage, `Send failed: ${error.message || "An unexpected error occurred."}`, "error", 6000);
                 }
             } finally {
                 showLoading(false);
                 // updateSendForm(); // Listener handles this if needed, called manually above after clearing
             }
         }

        // --- EVENT LISTENERS SETUP (Modified) ---
        function setupEventListeners() {
             if (listenersAttached) { console.warn("Attempted to attach event listeners multiple times."); return; }

             // Navigation
             navItems.forEach(item => { item.addEventListener('click', () => { showPage(item.dataset.page); triggerHapticFeedback('light'); }); });

             // Swap Page Listeners
             if (selectFromTokenBtn) selectFromTokenBtn.addEventListener('click', () => openTokenSelector('swap-from'));
             if (selectToTokenBtn) selectToTokenBtn.addEventListener('click', () => openTokenSelector('swap-to'));
             if (fromAmountInput) fromAmountInput.addEventListener('input', updateSwapUI);
             if (swapButton) swapButton.addEventListener('click', handleSwap);
             if (swapDirectionBtn) swapDirectionBtn.addEventListener('click', () => {
                 const fromAsset = selectFromTokenBtn.dataset.token;
                 const toAsset = selectToTokenBtn.dataset.token;
                 if (!fromAsset || !toAsset || fromAsset === toAsset) return; // Don't swap if invalid or same

                 // Swap data attributes
                 selectFromTokenBtn.dataset.token = toAsset;
                 selectToTokenBtn.dataset.token = fromAsset;

                 // Swap display on buttons
                 const fromBtnContent = selectFromTokenBtn.querySelector('.selected-token-info').innerHTML;
                 const toBtnContent = selectToTokenBtn.querySelector('.selected-token-info').innerHTML;
                 selectFromTokenBtn.querySelector('.selected-token-info').innerHTML = toBtnContent;
                 selectToTokenBtn.querySelector('.selected-token-info').innerHTML = fromBtnContent;

                 triggerHapticFeedback('medium');
                 updateSwapUI(); // Update UI immediately
             });

             // Receive Page Listener
             if (depositChatIdEl) depositChatIdEl.addEventListener('click', () => { if(currentUser && currentUser.id) copyTextToClipboard(String(currentUser.id), 'Chat ID'); else showGlobalMessage('User ID not available to copy.', 'info'); });

             // Send Page Listeners
             if (selectSendTokenBtn) selectSendTokenBtn.addEventListener('click', () => openTokenSelector('send'));
             if (sendAmountInput) sendAmountInput.addEventListener('input', updateSendForm);
             if (recipientIdInput) recipientIdInput.addEventListener('input', updateSendForm);
             if (sendButton) sendButton.addEventListener('click', handleSend);

            // Token Modal Listeners (NEW)
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeTokenSelector);
            if (tokenSelectorOverlay) tokenSelectorOverlay.addEventListener('click', (event) => { if (event.target === tokenSelectorOverlay) closeTokenSelector(); }); // Close on overlay click
            if (modalSearchInput) modalSearchInput.addEventListener('input', populateTokenList); // Filter list on search input

             // Global listener for theme changes
             if (tg && tg.onEvent) { tg.onEvent('themeChanged', () => applyTheme(tg.themeParams)); }

             // Transaction ID Copy Listener (delegated)
             if (transactionListEl) { /* Kept existing delegation logic */ }

             listenersAttached = true;
             console.log("Event listeners attached successfully.");
         }

        // --- INITIALIZATION (Modified) ---
        async function initializeApp() {
            console.log("Initializing AB Wallet App...");
            showLoading(true, 'Connecting...');

            // 1. Check Telegram Environment
             if (typeof window.Telegram === 'undefined' || !window.Telegram.WebApp) {
                 console.error("Fatal Error: Telegram WebApp SDK not found.");
                 showLoading(false);
                 if (appBlocker) { appBlocker.querySelector('p').textContent = 'This application can only be used inside the Telegram app.'; appBlocker.style.display = 'flex'; }
                 return;
             }
             tg = window.Telegram.WebApp;

            try {
                 // 2. Telegram Ready & Setup
                 tg.ready();
                 console.log("Telegram WebApp SDK Ready");
                 tg.expand();
                 applyTheme(tg.themeParams);
                 if (tg.setBackgroundColor) tg.setBackgroundColor(tg.themeParams.bg_color || '#121212');

                 // 3. Get User Data from Telegram
                 if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                     currentUser = tg.initDataUnsafe.user;
                     console.log("User Identified:", currentUser.id, `@${currentUser.username || ''}`);
                     updateHomePageUI();
                     updateDepositPageUI();
                 } else {
                     throw new Error("Could not retrieve Telegram user data.");
                 }

                 // 4. Initialize Firebase
                 showLoading(true, 'Connecting to Wallet...');
                 await initializeFirebase();

                 // 5. Fetch Static Token Data
                 showLoading(true, 'Loading Token Info...');
                 await getTokenData();
                 // No longer populate <select> here, modal handles it dynamically
                 // Set default tokens for swap page buttons visually if desired
                 // handleTokenSelection('USDT', 'swap-from'); // Example default - handle carefully
                 // handleTokenSelection('ANOTHER_TOKEN', 'swap-to'); // Example default


                 // 6. Get User's Wallet Data (Real-time)
                 showLoading(true, 'Loading Your Balances...');
                 await getUserDataRealtime(String(currentUser.id));

                 // 7. Initial UI Update (Send form needs balance info)
                 updateSendForm(); // Ensure send form reflects initial state

                 // 8. Setup Event Listeners
                 setupEventListeners();

                 // 9. Initialization Complete
                 showLoading(false);
                 showPage('homePage');
                 console.log("App Initialization Complete.");
                 tg.MainButton.hide();

            } catch (error) {
                 console.error("App Initialization Failed:", error);
                 showLoading(false);
                 triggerHapticFeedback('error');
                 if (error.message.includes("Telegram user data")) { if (appBlocker) { appBlocker.querySelector('h2').textContent = 'User Error'; appBlocker.querySelector('p').textContent = error.message; appBlocker.style.display = 'flex'; } }
                 else if (error.message.includes("Firebase")) { showGlobalMessage(`Database Connection Error: ${error.message}. Some features might be unavailable.`, "error", 0); }
                 else { showGlobalMessage(`Initialization Error: ${error.message || 'An unknown error occurred.'}. Please try restarting the app.`, "error", 0); }
            }
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
