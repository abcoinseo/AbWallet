<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AB Wallet</title>
    <!-- Telegram WebApp JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase App (Core) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Basic Reset & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling bounce on mobile */
        }

        body {
            display: flex;
            flex-direction: column;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }

        /* App Container */
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* Loading Indicator */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Page Container */
        main {
            flex-grow: 1; /* Takes remaining vertical space */
            overflow-y: auto; /* Allows scrolling within the page content */
            padding: 20px;
        }

        /* Page Styling */
        .page {
            display: none; /* Hide pages by default */
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block; /* Show active page */
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Navigation Bar */
        nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-secondary-bg-color, #f8f8f8);
            flex-shrink: 0; /* Prevent nav from shrinking */
        }

        nav button {
            background: none;
            border: none;
            color: var(--tg-theme-link-color, #007aff);
            font-size: 1em;
            padding: 10px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: background-color 0.2s, color 0.2s;
            border-radius: 5px;
            margin: 0 5px;
        }

        nav button.active {
            color: var(--tg-theme-button-text-color, #ffffff);
            background-color: var(--tg-theme-button-color, #007aff);
        }

        nav button:disabled {
            color: var(--tg-theme-hint-color, #999);
            cursor: not-allowed;
        }

        /* Common Elements */
        h1, h2 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .balance-display {
            font-size: 2.5em;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
            color: var(--tg-theme-link-color, #007aff);
        }

        .user-info {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .user-info p {
            margin-bottom: 5px;
        }
        .user-info strong {
             color: var(--tg-theme-text-color, #333);
        }
        .user-info span {
             color: var(--tg-theme-hint-color, #555);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 5px;
            font-size: 1em;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
         input[type="number"]::-webkit-inner-spin-button,
         input[type="number"]::-webkit-outer-spin-button {
           -webkit-appearance: none;
           margin: 0;
         }
         input[type="number"] {
           -moz-appearance: textfield; /* Firefox */
         }

        button.action-button {
            width: 100%;
            padding: 15px;
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button.action-button:hover:not(:disabled) {
            opacity: 0.9;
        }
         button.action-button:disabled {
            background-color: var(--tg-theme-hint-color, #ccc);
            cursor: not-allowed;
         }

        /* Specific Page Content Styles */
        #deposit-page .address-display {
            background-color: var(--tg-theme-secondary-bg-color, #eee);
            padding: 10px;
            border-radius: 4px;
            word-wrap: break-word;
            font-family: monospace;
            margin-top: 10px;
        }

        #swap-page .swap-container {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }
        #swap-page .swap-arrow {
             text-align: center;
             font-size: 1.5em;
             margin: 5px 0;
         }

    </style>
</head>
<body>

    <div id="app">
        <!-- Loading Overlay -->
        <div id="loading">Loading...</div>

        <!-- Main Content Area -->
        <main>
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <h1>Welcome to AB Wallet!</h1>
                <div class="user-info" id="user-info-display">
                    <p>Loading user data...</p>
                </div>
                <h2>Your Balance</h2>
                <div class="balance-display" id="balance-display">$0.00</div>
                <p>Manage your assets easily within Telegram.</p>
            </div>

            <!-- Swap Page -->
            <div id="swap-page" class="page">
                <h1>Swap Assets</h1>
                 <p>Feature coming soon!</p>
                 <div class="swap-container">
                     <div class="form-group">
                         <label for="swap-from-amount">From:</label>
                         <input type="number" id="swap-from-amount" placeholder="0.0" disabled>
                         <!-- Add currency selector here later -->
                     </div>
                     <div class="swap-arrow">â†“</div>
                     <div class="form-group">
                         <label for="swap-to-amount">To:</label>
                         <input type="number" id="swap-to-amount" placeholder="0.0" disabled>
                          <!-- Add currency selector here later -->
                     </div>
                     <button class="action-button" disabled>Swap (Unavailable)</button>
                 </div>
            </div>

            <!-- Deposit Page -->
            <div id="deposit-page" class="page">
                <h1>Deposit Funds</h1>
                <p>To deposit funds, send assets to the following address (Example Only):</p>
                <div class="address-display" id="deposit-address">
                    0xAbCdEfGhIjKlMnOpQrStUvWxYz1234567890aBcDeF
                </div>
                <p style="margin-top: 15px; font-weight: bold; color: orange;">Note: This is a placeholder address. Do not send real funds.</p>
                <p>Your balance will update automatically after the transaction is confirmed.</p>
            </div>

            <!-- Withdraw Page -->
            <div id="withdraw-page" class="page">
                <h1>Withdraw Funds</h1>
                <p>Current Balance: <span id="withdraw-balance">$0.00</span></p>
                <div class="form-group">
                    <label for="withdraw-address">Recipient Address:</label>
                    <input type="text" id="withdraw-address" placeholder="Enter wallet address">
                </div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount ($):</label>
                    <input type="number" id="withdraw-amount" placeholder="0.00" step="0.01">
                </div>
                <button id="withdraw-button" class="action-button">Withdraw</button>
                <p id="withdraw-status" style="margin-top: 15px; text-align: center;"></p>
            </div>
        </main>

        <!-- Navigation -->
        <nav id="nav-bar">
            <button data-page="home-page" class="active">Home</button>
            <button data-page="swap-page">Swap</button>
            <button data-page="deposit-page">Deposit</button>
            <button data-page="withdraw-page">Withdraw</button>
        </nav>
    </div>

    <script>
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg", // Replace with your actual key if needed, but use rules!
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.firebasestorage.app",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- Globals ---
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let userBalance = 0.0;
        let firebaseApp = null;
        let database = null;
        let userDbRef = null;

        // --- DOM Elements ---
        const loadingIndicator = document.getElementById('loading');
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('#nav-bar button');
        const userInfoDisplay = document.getElementById('user-info-display');
        const balanceDisplay = document.getElementById('balance-display');
        const withdrawBalanceDisplay = document.getElementById('withdraw-balance');
        const withdrawAddressInput = document.getElementById('withdraw-address');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawButton = document.getElementById('withdraw-button');
        const withdrawStatus = document.getElementById('withdraw-status');


        // --- Functions ---

        /**
         * Shows the specified page and hides others. Updates nav button active state.
         * @param {string} pageId The ID of the page to show.
         */
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
                if (page.id === pageId) {
                    page.classList.add('active');
                }
            });

            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.page === pageId) {
                    button.classList.add('active');
                }
            });

            // Special updates when a page is shown
            if (pageId === 'withdraw-page') {
                updateWithdrawPageBalance();
                 withdrawStatus.textContent = ''; // Clear status on page load
                 withdrawAddressInput.value = '';
                 withdrawAmountInput.value = '';
            }
             if (pageId === 'home-page') {
                 // Balance is updated via realtime listener anyway
             }
        }

        /**
         * Updates the balance display elements.
         * @param {number} newBalance The new balance amount.
         */
        function updateBalanceDisplay(newBalance) {
            userBalance = parseFloat(newBalance.toFixed(2)); // Ensure 2 decimal places
            balanceDisplay.textContent = `$${userBalance.toFixed(2)}`;
            updateWithdrawPageBalance(); // Also update the withdraw page display
        }

        /**
         * Updates the balance shown on the withdraw page specifically.
         */
        function updateWithdrawPageBalance() {
             withdrawBalanceDisplay.textContent = `$${userBalance.toFixed(2)}`;
        }


        /**
         * Displays the fetched Telegram user data on the Home page.
         */
        function displayUserInfo() {
            if (!currentUser) {
                userInfoDisplay.innerHTML = '<p>Could not load user data.</p>';
                return;
            }
            userInfoDisplay.innerHTML = `
                <p><strong>User ID:</strong> <span>${currentUser.id}</span></p>
                <p><strong>First Name:</strong> <span>${currentUser.first_name || 'N/A'}</span></p>
                <p><strong>Last Name:</strong> <span>${currentUser.last_name || 'N/A'}</span></p>
                <p><strong>Username:</strong> <span>${currentUser.username ? '@' + currentUser.username : 'N/A'}</span></p>
            `;
        }

        /**
         * Initializes Firebase connection and user data handling.
         */
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.app(); // if already initialized
                }
                database = firebase.database();
                console.log("Firebase Initialized");

                if (currentUser && currentUser.id) {
                    const userId = currentUser.id.toString(); // Use Telegram user ID as Firebase key
                    userDbRef = database.ref('users/' + userId);

                    // Check if user exists, create if not, and listen for balance changes
                    userDbRef.once('value').then((snapshot) => {
                        if (!snapshot.exists()) {
                            console.log(`User ${userId} not found. Creating...`);
                            // Create new user record
                            userDbRef.set({
                                telegram_id: currentUser.id,
                                first_name: currentUser.first_name || null,
                                last_name: currentUser.last_name || null,
                                username: currentUser.username || null,
                                balance: 0.00, // Initial balance
                                created_at: firebase.database.ServerValue.TIMESTAMP
                            }).then(() => {
                                console.log("User created successfully with balance 0");
                                setupBalanceListener(); // Start listening after creation
                                updateBalanceDisplay(0.00);
                                hideLoading();
                            }).catch(handleFirebaseError);
                        } else {
                            console.log(`User ${userId} found.`);
                             const userData = snapshot.val();
                             // Update user info in firebase if needed (optional)
                             userDbRef.update({
                                 first_name: currentUser.first_name || userData.first_name || null,
                                 last_name: currentUser.last_name || userData.last_name || null,
                                 username: currentUser.username || userData.username || null,
                             });
                             // Initial balance load
                             updateBalanceDisplay(userData.balance || 0.00);
                             setupBalanceListener(); // Start listening for existing user
                             hideLoading();
                        }
                    }).catch(handleFirebaseError);

                } else {
                    console.error("No user ID found to initialize Firebase path.");
                    displayError("Could not identify user for database operations.");
                    hideLoading();
                }

            } catch (error) {
                handleFirebaseError(error);
                 hideLoading();
            }
        }

        /**
         * Sets up the real-time listener for balance changes in Firebase.
         */
        function setupBalanceListener() {
            if (!userDbRef) return;

            // Detach previous listener if any (safety measure)
            userDbRef.child('balance').off('value');

            // Attach new listener
            userDbRef.child('balance').on('value', (snapshot) => {
                const newBalance = snapshot.val() || 0.00;
                console.log("Realtime balance update:", newBalance);
                updateBalanceDisplay(newBalance);
            }, (error) => {
                console.error("Error listening to balance changes:", error);
                // Optional: Show a subtle error to the user that real-time updates might be paused
                tg.showAlert("Error syncing balance. Please try refreshing.");
            });
             console.log("Balance listener attached.");
        }


        /**
         * Handles the withdrawal process (DEMO - INSECURE).
         */
        async function handleWithdraw() {
            const address = withdrawAddressInput.value.trim();
            const amountStr = withdrawAmountInput.value.trim();
            const amount = parseFloat(amountStr);

            withdrawStatus.textContent = ''; // Clear previous status

            // --- Basic Client-Side Validation ---
            if (!address) {
                withdrawStatus.textContent = 'Error: Please enter a recipient address.';
                withdrawStatus.style.color = 'red';
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                withdrawStatus.textContent = 'Error: Please enter a valid positive amount.';
                 withdrawStatus.style.color = 'red';
                return;
            }
            if (amount > userBalance) {
                withdrawStatus.textContent = 'Error: Insufficient balance.';
                 withdrawStatus.style.color = 'red';
                return;
            }
            // --- End Validation ---

            // **WARNING:** This is where SERVER-SIDE processing MUST happen in a real app.
            // The client should send the request (address, amount) to a secure backend.
            // The backend verifies the user, checks balance, processes the transaction,
            // interacts with blockchain/payment provider, and THEN updates the Firebase balance.

            // --- SIMULATED Client-Side Update (FOR DEMO ONLY) ---
            withdrawButton.disabled = true;
            withdrawStatus.textContent = 'Processing withdrawal...';
            withdrawStatus.style.color = 'orange';

            const newBalance = userBalance - amount;

            if (userDbRef) {
                try {
                    // Update balance in Firebase
                    await userDbRef.child('balance').set(newBalance);

                     // Add a transaction record (optional, good practice)
                     const transactionRef = database.ref('transactions/' + currentUser.id.toString()).push();
                     await transactionRef.set({
                         type: 'withdraw',
                         amount: amount,
                         address: address,
                         timestamp: firebase.database.ServerValue.TIMESTAMP,
                         status: 'completed' // In real app, status might be 'pending' first
                     });

                    console.log(`Withdrawal successful. New balance: ${newBalance}`);
                    // The real-time listener should automatically update the UI balance
                    withdrawStatus.textContent = 'Withdrawal successful!';
                    withdrawStatus.style.color = 'green';
                    // Clear inputs after success
                    withdrawAddressInput.value = '';
                    withdrawAmountInput.value = '';

                } catch (error) {
                    console.error("Withdrawal Error (Firebase Update):", error);
                    withdrawStatus.textContent = 'Error processing withdrawal. Please try again.';
                    withdrawStatus.style.color = 'red';
                     // Optional: Consider reverting the UI balance optimistically if the write fails
                     // updateBalanceDisplay(userBalance); // Revert UI if needed
                } finally {
                     withdrawButton.disabled = false;
                }
            } else {
                withdrawStatus.textContent = 'Error: Database connection lost.';
                withdrawStatus.style.color = 'red';
                withdrawButton.disabled = false;
            }
        }


        /**
         * Hides the loading indicator.
         */
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }
        /**
         * Shows the loading indicator.
         */
        function showLoading() {
             loadingIndicator.classList.remove('hidden');
        }


        /**
         * Handles Firebase errors.
         * @param {Error} error The Firebase error object.
         */
        function handleFirebaseError(error) {
            console.error("Firebase Error:", error);
            displayError(`Firebase Error: ${error.message}. Please check console and ensure Firebase setup and rules are correct.`);
            hideLoading(); // Hide loading on error
        }
         /**
         * Displays a generic error message to the user via Telegram alert.
         * @param {string} message The error message to display.
         */
        function displayError(message) {
            tg.showAlert(message);
        }


        // --- Event Listeners ---

        // Navigation Button Clicks
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pageId = button.dataset.page;
                showPage(pageId);
            });
        });

         // Withdraw Button Click
         withdrawButton.addEventListener('click', handleWithdraw);


        // --- Initialization ---

        // Function to run when the Telegram Web App is ready
        function onWebAppReady() {
            console.log("Telegram WebApp is Ready");
             tg.expand(); // Expand the webapp to full height

            // Apply theme colors
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
            document.body.style.color = tg.themeParams.text_color || '#000000';
            // You can apply more specific theme colors to elements here if needed

             // Get user data (use unsafe version as recommended for general info display)
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
                console.log("User Data:", currentUser);
                displayUserInfo();
                initializeFirebase(); // Initialize Firebase after getting user data
            } else {
                console.error("Could not retrieve user data from Telegram.");
                userInfoDisplay.innerHTML = '<p style="color: red;">Error: Could not get user data. Are you running this inside Telegram?</p>';
                hideLoading(); // Hide loading if user data fails
                 // Optionally disable features or show an error message
                 navButtons.forEach(b => b.disabled = true);
                 withdrawButton.disabled = true;
                 tg.showAlert("Could not load user information. Wallet functionality is disabled.");
            }
        }

        // Add listener for Telegram WebApp ready event
        tg.ready();
        onWebAppReady(); // Call readiness logic immediately after tg.ready()

        // Initial page setup (redundant but safe)
        showPage('home-page');

    </script>

</body>
</html>
