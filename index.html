<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing meta tags, title, SDK scripts -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AB Wallet Pro</title> <!-- Updated Title -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Optional: Include tinycolor library -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> -->

    <style>
        :root {
            --bg-color: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --card-bg: #1e1e1e;
            --accent-color: #1DB954; /* Default: Spotify Green */
            --button-bg: var(--accent-color);
            --button-text: #ffffff;
            --input-bg: #282828;
            --border-color: #333333; /* Subtle border */
            --error-color: #f44336;
            --success-color: #4caf50;
            --warning-color: #ffa726;
            --link-color: #8774e1; /* Telegram link color */
            --receive-color: var(--success-color);
            --send-color: var(--error-color);
            --swap-color: #ff9800;
            --hover-bg: rgba(255, 255, 255, 0.07); /* Slightly more visible hover */
            --modal-bg: #2a2a2a;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --shadow-color: rgba(0, 0, 0, 0.25); /* Consistent shadow color */
             --accent-rgb: 29, 185, 84; /* Default accent RGB for RGBA usage */
        }

        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: var(--primary-text); overscroll-behavior: none; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; font-size: 15px; /* Slightly larger base font */ line-height: 1.5; }
        .app-container { flex-grow: 1; padding: 25px 15px 80px 15px; /* More top/bottom padding */ overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* --- Page Sections --- */
        .page { display: none; animation: fadeIn 0.3s ease-out; } /* Smoother fade */
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; /* transform: translateY(5px); subtle */ } to { opacity: 1; /* transform: translateY(0); */ } }

        /* --- Navigation --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--card-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border-color); z-index: 1000; box-shadow: 0 -4px 12px var(--shadow-color); } /* Refined shadow */
        .nav-item { background: none; border: none; color: var(--secondary-text); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; padding: 8px 5px; transition: color 0.2s ease, transform 0.1s ease; flex: 1; text-align: center; height: 100%; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; transition: transform 0.2s ease; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item.active svg { transform: scale(1.1); } /* Subtle scale for active icon */
        .nav-item:not(.active):hover { color: var(--primary-text); }
        .nav-item:active { transform: scale(0.95); }

        /* --- Common Elements --- */
        h1, h2, h3 { color: var(--primary-text); margin-bottom: 15px; line-height: 1.3; }
        h1 { font-size: 26px; font-weight: 700; text-align: center; margin-bottom: 30px; } /* Bolder H1 */
        h2 { font-size: 19px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-bottom: 20px; } /* Slightly larger H2 */
        h3 { font-size: 17px; color: var(--primary-text); margin-bottom: 15px; font-weight: 600; } /* Bolder H3 */
        .card { background-color: var(--card-bg); padding: 25px; /* Increased padding */ border-radius: 16px; /* More rounded */ margin-bottom: 30px; box-shadow: 0 4px 10px var(--shadow-color); /* Softer shadow */ border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle border */ }
        .balance-display { font-size: 40px; /* Larger */ font-weight: 700; color: var(--primary-text); text-align: center; margin-bottom: 8px; }
        .balance-display span { font-size: 18px; /* Larger */ font-weight: 500; /* Medium weight */ color: var(--secondary-text); margin-left: 8px; }
        .balance-subtitle { text-align: center; color: var(--secondary-text); font-size: 14px; margin-top: 0px; margin-bottom: 30px; } /* More margin bottom */
        .user-info p { margin-bottom: 12px; color: var(--secondary-text); font-size: 15px; /* Larger */ display: flex; justify-content: space-between; align-items: center; }
        .user-info strong { color: var(--primary-text); font-weight: 500; margin-right: 15px; /* More space */ }
        .user-info span { text-align: right; word-break: break-all; color: var(--primary-text); font-weight: 500; /* Value bolder */ }
        label { display: block; margin-bottom: 10px; /* More space */ color: var(--secondary-text); font-size: 14px; font-weight: 500; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 15px 18px; /* More padding */ margin-bottom: 15px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 10px; /* More rounded */ color: var(--primary-text); font-size: 16px; appearance: none; -webkit-appearance: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.25); /* Use accent RGB */ }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-helper-text { font-size: 13px; /* Slightly larger */ color: var(--secondary-text); margin-top: -10px; margin-bottom: 18px; /* More space */ min-height: 18px; display: block; }
        .input-helper-text.warning { color: var(--warning-color); font-weight: 500; }
        button { background: linear-gradient(90deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, black) 100%); /* Refined gradient */ color: var(--button-text); border: none; padding: 16px 25px; /* More padding */ border-radius: 12px; /* Less round, more modern */ cursor: pointer; font-size: 16px; font-weight: 600; text-align: center; width: 100%; transition: all 0.25s ease; margin-top: 20px; /* More space */ display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 3px 6px color-mix(in srgb, var(--accent-color) 40%, black); /* Accent shadow */ }
        button:hover { filter: brightness(1.1); box-shadow: 0 5px 10px color-mix(in srgb, var(--accent-color) 50%, black); }
        button:active { transform: scale(0.98); filter: brightness(0.95); box-shadow: 0 2px 4px color-mix(in srgb, var(--accent-color) 30%, black); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; opacity: 0.7; box-shadow: none; filter: none; }
        button svg { width: 20px; height: 20px; fill: currentColor; }
        .message { padding: 15px 20px; margin: 20px 0; border-radius: 10px; text-align: center; font-size: 14px; font-weight: 500; border: 1px solid transparent; line-height: 1.4; }
        .message.error { background-color: rgba(244, 67, 54, 0.1); color: var(--error-color); border-color: rgba(244, 67, 54, 0.3); }
        .message.success { background-color: rgba(76, 175, 80, 0.1); color: var(--success-color); border-color: rgba(76, 175, 80, 0.3); }
        .message.info { background-color: rgba(33, 150, 243, 0.1); color: var(--link-color); border-color: rgba(33, 150, 243, 0.3); }
        .loading-indicator { text-align: center; padding: 40px 20px; color: var(--secondary-text); display: none; font-size: 16px; }
        .loading-indicator.active { display: block; }
        .loading-indicator::before { content: ''; display: inline-block; width: 26px; height: 26px; border: 4px solid rgba(255,255,255,0.2); border-radius: 50%; border-top-color: var(--primary-text); animation: spin 1s linear infinite; /* Linear spin */ margin-right: 12px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-id-display { background-color: var(--input-bg); padding: 18px 20px; /* More padding */ border-radius: 10px; font-family: 'Courier New', Courier, monospace; word-break: break-all; margin-top: 10px; margin-bottom: 15px; border: 1px dashed var(--border-color); cursor: pointer; text-align: center; color: var(--primary-text); font-size: 17px; /* Larger */ transition: background-color 0.2s, border-color 0.2s; }
        .chat-id-display:hover { background-color: var(--hover-bg); border-color: var(--accent-color); }
        .copy-feedback { font-size: 13px; color: var(--success-color); text-align: center; height: 20px; margin-bottom: 15px; opacity: 0; transition: opacity 0.3s ease; font-weight: 500; }
        .copy-feedback.visible { opacity: 1; }

        /* --- Transaction History --- */
        .transaction-history ul { list-style: none; padding: 0; max-height: 400px; /* More height */ overflow-y: auto; margin: -10px 0; /* Overlap border */ }
        .transaction-history li { background-color: transparent; padding: 18px 5px; /* More vertical padding */ margin-bottom: 0px; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--secondary-text); display: flex; justify-content: space-between; align-items: center; /* Center items vertically */ transition: background-color 0.2s ease; }
        .transaction-history li:hover { background-color: var(--hover-bg); }
        .transaction-history li:last-child { border-bottom: none; }
        .transaction-history li .tx-details { flex-grow: 1; margin-right: 15px; /* More space */ display: flex; align-items: center; gap: 15px; /* Gap between icon and text */ }
        .transaction-history li .tx-type-icon { width: 24px; height: 24px; flex-shrink: 0; /* Removed top margin */ }
        /* Removed tx-main-info wrapper, direct children */
        .transaction-history li span.tx-amount { font-weight: 600; color: var(--primary-text); }
        .transaction-history li span.tx-asset { font-weight: 500; color: var(--primary-text); margin-left: 4px; } /* Space before asset */
        .transaction-history li .tx-desc { /* New wrapper for main info + peer */ line-height: 1.4; }
        .transaction-history li span.tx-peer { font-size: 13px; /* Larger */ display: block; margin-top: 3px; color: var(--secondary-text); word-break: break-all; }
        .transaction-history li span.tx-peer strong { color: var(--primary-text); font-weight: 500; }
        .transaction-history li span.tx-id { font-size: 11px; display: block; margin-top: 4px; color: var(--secondary-text); font-family: monospace; word-break: break-all; opacity: 0.6; /* Slightly less visible */ cursor: pointer; transition: opacity 0.2s; }
        .transaction-history li span.tx-id:hover { opacity: 1; }
        .transaction-history li .tx-timestamp { font-size: 13px; /* Larger */ color: var(--secondary-text); white-space: nowrap; text-align: right; padding-left: 10px; }
        .transaction-history li.receive .tx-amount { color: var(--receive-color); }
        .transaction-history li.send .tx-amount { color: var(--send-color); }
        .transaction-history li.swap .tx-amount { color: var(--swap-color); }
        .transaction-history li.swap span.tx-amount:nth-child(2) { color: var(--receive-color); margin-left: 0; } /* Fix swap spacing */

        /* --- Asset List (Home Page) --- */
        #assetList { margin: -10px 0; } /* Overlap border like tx history */
        .token-list-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 5px; /* Adjusted padding */ border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; gap: 15px; /* Gap between info and balance */ }
         .token-list-item:hover { background-color: var(--hover-bg); }
         .token-list-item:last-child { border-bottom: none; }
         .token-list-item .token-info { display: flex; align-items: center; gap: 15px; /* Gap between image and text */ }
         .token-list-item img { width: 40px; /* Larger logo */ height: 40px; margin-right: 0; /* Handled by gap */ border-radius: 50%; background-color: #333; border: 1px solid var(--border-color); }
         .token-list-item .token-name-symbol { line-height: 1.3; } /* Group name/symbol */
         .token-list-item .token-name { font-weight: 600; color: var(--primary-text); font-size: 16px; /* Larger */ }
         .token-list-item .token-symbol { font-size: 13px; color: var(--secondary-text); }
         .token-list-item .token-balance { text-align: right; line-height: 1.3; }
         .token-list-item .balance-amount { font-weight: 600; /* Bolder */ color: var(--primary-text); font-size: 16px; /* Larger */ }
         .token-list-item .balance-usd { font-size: 13px; color: var(--secondary-text); margin-top: 2px; }

        /* --- Swap Page Elements --- */
        .swap-icon { text-align: center; margin: 20px 0; /* More margin */ font-size: 28px; cursor: pointer; color: var(--accent-color); transform: rotate(90deg); transition: transform 0.3s ease, color 0.2s ease; line-height: 1; }
        .swap-icon:hover { transform: rotate(270deg) scale(1.1); color: #ffffff; } /* Added scale */
        #swapFeeInfo { font-size: 13px; color: var(--secondary-text); text-align: center; margin-top: -5px; margin-bottom: 25px; /* More space */ min-height: 18px; }
        #swapFeeInfo.warning { color: var(--warning-color); font-weight: 500; } /* Ensure warning style */
        #swapRate { font-size: 14px; min-height: 20px; margin-bottom: 10px; /* More space */ }

        /* --- Token Selector Button --- */
        .token-selector-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 18px;
            margin-bottom: 10px; /* Less margin below button */
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--primary-text);
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        .token-selector-button:hover {
            background-color: var(--hover-bg);
            border-color: var(--secondary-text);
        }
        .token-selector-button .selected-token-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .token-selector-button img {
            width: 30px; /* Slightly larger */
            height: 30px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid var(--border-color);
        }
        .token-selector-button .token-name-symbol { line-height: 1.3; }
        .token-selector-button .token-name { font-weight: 600; /* Bolder */ font-size: 16px; }
        .token-selector-button .token-symbol { font-size: 13px; color: var(--secondary-text); }
        .token-selector-button .select-prompt { color: var(--secondary-text); font-style: italic; font-size: 15px; }
        .token-selector-button .dropdown-arrow { margin-left: 10px; color: var(--secondary-text); font-size: 20px; transform: translateY(1px); }

        /* --- Token Selector Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); display: flex; justify-content: center; align-items: flex-end; z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .token-selector-modal { background-color: var(--modal-bg); width: 100%; max-width: 600px; max-height: 75vh; border-radius: 20px 20px 0 0; /* More rounded */ display: flex; flex-direction: column; box-shadow: 0 -5px 20px var(--shadow-color); transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1); /* Smoother transition */ }
        .modal-overlay.active .token-selector-modal { transform: translateY(0); }
        .modal-header { padding: 18px 25px; /* More padding */ border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .modal-close-button { background: none; border: none; color: var(--secondary-text); font-size: 26px; cursor: pointer; line-height: 1; padding: 5px; transition: color 0.2s ease; }
        .modal-close-button:hover { color: var(--primary-text); }
        .modal-search-container { padding: 15px 25px; border-bottom: 1px solid var(--border-color); }
        .modal-search-input { width: 100%; padding: 14px 18px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 10px; color: var(--primary-text); font-size: 15px; margin: 0; }
        .modal-search-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.2); }
        .modal-token-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .modal-token-list-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; /* Match header padding */ cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; gap: 15px; }
        .modal-token-list-item:last-child { border-bottom: none; }
        .modal-token-list-item:hover { background-color: var(--hover-bg); }
        .modal-token-list-item .token-info { display: flex; align-items: center; gap: 15px; }
        .modal-token-list-item img { width: 40px; /* Match home list */ height: 40px; border-radius: 50%; background-color: #333; border: 1px solid var(--border-color); }
        .modal-token-list-item .token-name-symbol { line-height: 1.3; }
        .modal-token-list-item .token-name { font-weight: 600; color: var(--primary-text); font-size: 16px; }
        .modal-token-list-item .token-symbol { font-size: 13px; color: var(--secondary-text); }
        .modal-token-list-item .token-balance { text-align: right; line-height: 1.3; }
        .modal-token-list-item .balance-amount { font-weight: 600; /* Bolder */ color: var(--primary-text); font-size: 15px; }
        .modal-token-list-item .balance-usd { font-size: 12px; color: var(--secondary-text); margin-top: 2px; }
        .modal-token-list-item.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(50%); } /* More distinct disabled style */
        .modal-token-list-item.disabled:hover { background-color: transparent; }
        .modal-list-empty { padding: 40px 25px; text-align: center; color: var(--secondary-text); font-style: italic; }

        /* Blocker */
        #appBlocker { /* ... existing styles ... */ }


    </style>
</head>
<body>

    <!-- Blocker -->
    <div id="appBlocker">
         <svg width="64" height="64" viewBox="0 0 24 24" fill="#ffffff"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
         <h2>Access Error</h2>
         <p>This application requires the Telegram app environment.</p>
    </div>

    <!-- Token Selector Modal -->
    <div id="tokenSelectorOverlay" class="modal-overlay">
        <div id="tokenSelectorModal" class="token-selector-modal">
            <div class="modal-header">
                <h3 id="modalTitle">Select Token</h3>
                <button id="modalCloseBtn" class="modal-close-button" aria-label="Close">×</button>
            </div>
            <div class="modal-search-container">
                <input type="text" id="modalSearchInput" class="modal-search-input" placeholder="Search by name or symbol...">
            </div>
            <ul id="modalTokenList" class="modal-token-list">
                <li class="modal-list-empty">Loading tokens...</li>
            </ul>
        </div>
    </div>


    <div class="app-container">

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator active">Initializing...</div>

        <!-- Global Message Area -->
        <div id="globalMessage" class="message" style="display: none;"></div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <h1 id="welcomeMessage">Welcome!</h1>
            <div class="card">
                <h2>Total Balance</h2>
                <div class="balance-display" id="totalBalance">$0.00 <span>USD</span></div>
                <p class="balance-subtitle">Estimated value across all assets</p>
                 <div id="detailedBalances">
                     <h3>Your Assets</h3>
                     <ul id="assetList" style="list-style: none; padding: 0;">
                         <li style="color: var(--secondary-text); text-align: center; padding: 20px 0;">Loading assets...</li>
                     </ul>
                 </div>
            </div>
            <div class="card user-info">
                <h2>Account Info</h2>
                <p><strong>First Name:</strong> <span id="userFirstName">...</span></p>
                <p><strong>Last Name:</strong> <span id="userLastName">...</span></p>
                <p><strong>Username:</strong> <span id="userUsername">...</span></p>
                <p><strong>Chat ID:</strong> <span id="userChatId">...</span></p>
            </div>
             <div class="card transaction-history">
                 <h2>Recent Activity</h2>
                 <ul id="transactionList">
                    <li style="color: var(--secondary-text); text-align: center; border: none; padding: 20px 0;">Loading transactions...</li>
                 </ul>
            </div>
        </div>

        <!-- Swap Page -->
        <div id="swapPage" class="page">
            <h1>Swap Assets</h1>
            <div class="card">
                <div id="swapMessage" class="message" style="display: none;"></div>

                <label for="selectFromTokenBtn">From:</label>
                <button id="selectFromTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info"><span class="select-prompt">Select Token</span></span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <label for="fromAmount" class="sr-only">Amount to Swap From</label> <!-- Hidden label for accessibility -->
                <input type="number" id="fromAmount" placeholder="0.0" min="0" step="any" inputmode="decimal">
                <p class="input-helper-text">Balance: <span id="swapFromBalance">0.00</span></p>

                <div class="swap-icon" id="swapDirectionBtn" title="Swap Tokens">⇅</div>

                <label for="selectToTokenBtn">To (Estimated):</label>
                 <button id="selectToTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info"><span class="select-prompt">Select Token</span></span>
                     <span class="dropdown-arrow">▼</span>
                </button>
                <label for="toAmount" class="sr-only">Estimated Amount to Receive</label> <!-- Hidden label for accessibility -->
                <input type="number" id="toAmount" placeholder="0.0" readonly style="background-color: var(--input-bg); opacity: 0.8; cursor: default;">
                 <p class="input-helper-text">Balance: <span id="swapToBalance">0.00</span></p>

                <p id="swapRate" style="text-align: center; color: var(--secondary-text); ">Select tokens to see rate</p>
                <p id="swapFeeInfo"></p>

                <button id="swapButton" disabled>
                    <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
                    Swap
                </button>
            </div>
        </div>

        <!-- Receive Page -->
        <div id="depositPage" class="page">
            <h1>Receive Assets</h1>
            <div class="card">
                 <div id="depositMessage" class="message" style="display: none;"></div>
                <p style="color: var(--secondary-text); margin-bottom: 25px; font-size: 14px; text-align: center; line-height: 1.5;">
                    Share your Telegram Chat ID below with other AB Wallet users so they can send assets directly to you.
                </p>
                <h3>Your Telegram Chat ID</h3>
                <div id="depositChatId" class="chat-id-display" title="Click to copy">Loading...</div>
                <div id="copyFeedbackDeposit" class="copy-feedback">Click the ID above to copy</div>
                 <p style="color: var(--secondary-text); font-size: 13px; margin-top: 25px; text-align: center; opacity: 0.8;">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px; transform: translateY(-1px);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Only use this ID for receiving assets within this AB Wallet app.
                 </p>
            </div>
        </div>

        <!-- Send Page -->
        <div id="sendPage" class="page">
            <h1>Send Assets</h1>
            <div class="card">
                 <div id="sendMessage" class="message" style="display: none;"></div>

                <label for="selectSendTokenBtn">Asset:</label>
                 <button id="selectSendTokenBtn" class="token-selector-button" data-token="">
                    <span class="selected-token-info"><span class="select-prompt">Select Asset to Send</span></span>
                     <span class="dropdown-arrow">▼</span>
                </button>

                <label for="sendAmount">Amount:</label>
                <input type="number" id="sendAmount" placeholder="0.0" min="0" step="any" inputmode="decimal">
                <p class="input-helper-text">
                    <span style="float: left;" id="sendUsdValueInfo">≈ $0.00 USD</span>
                    <span style="float: right;">Available: <strong id="sendAvailableBalance" style="color: var(--primary-text); font-weight: 600;">0.00</strong></span>
                    <span style="clear: both; display: block;"></span>
                </p>

                <label for="recipientId">Recipient Telegram Chat ID:</label>
                <input type="number" id="recipientId" placeholder="Enter recipient's numeric Chat ID" inputmode="numeric">

                <p style="color: var(--secondary-text); font-size: 13px; margin: 25px 0; text-align: center; opacity: 0.8; line-height: 1.4;">
                     <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px; transform: translateY(-1px);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Ensure the recipient ID is correct. Transactions are irreversible. Minimum send value $${MIN_SEND_USD_VALUE.toFixed(2)}.
                </p>

                <button id="sendButton" disabled>
                    <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    Send
                </button>
            </div>
        </div>

        <!-- Accessibility helper -->
        <span class="sr-only" style="position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;"></span>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="homePage">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
            Home
        </button>
        <button class="nav-item" data-page="swapPage">
             <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            Swap
        </button>
        <button class="nav-item" data-page="depositPage">
             <svg viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4v2z M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            Receive
        </button>
        <button class="nav-item" data-page="sendPage">
             <svg viewBox="0 0 24 24"><path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            Send
        </button>
    </nav>

    <script>
        const firebaseConfig = { /* --- PASTE YOUR CONFIG HERE --- */ };

        // --- GLOBAL STATE --- (Keep previous state vars)
        let currentUser = null; let userDbRef = null; let db = null; let userBalance = {}; let tokenData = {}; let userTransactions = {}; let tg = null; let firebaseInitialized = false; let listenersAttached = false; const SWAP_FEE_PERCENT = 0.005; const MIN_SEND_USD_VALUE = 0.80; const MIN_SWAP_USD_VALUE = 0.50; let currentModalContext = null;

        // --- DOM Elements --- (Keep previous element refs)
        const loadingIndicator = document.getElementById('loadingIndicator'); const globalMessage = document.getElementById('globalMessage'); const pages = document.querySelectorAll('.page'); const navItems = document.querySelectorAll('.nav-item'); const appContainer = document.querySelector('.app-container'); const appBlocker = document.getElementById('appBlocker'); const welcomeMessageEl = document.getElementById('welcomeMessage'); const totalBalanceEl = document.getElementById('totalBalance'); const userFirstNameEl = document.getElementById('userFirstName'); const userLastNameEl = document.getElementById('userLastName'); const userUsernameEl = document.getElementById('userUsername'); const userChatIdEl = document.getElementById('userChatId'); const assetListEl = document.getElementById('assetList'); const transactionListEl = document.getElementById('transactionList'); const selectFromTokenBtn = document.getElementById('selectFromTokenBtn'); const selectToTokenBtn = document.getElementById('selectToTokenBtn'); const fromAmountInput = document.getElementById('fromAmount'); const toAmountInput = document.getElementById('toAmount'); const swapButton = document.getElementById('swapButton'); const swapMessage = document.getElementById('swapMessage'); const swapRateEl = document.getElementById('swapRate'); const swapFeeInfoEl = document.getElementById('swapFeeInfo'); const swapDirectionBtn = document.getElementById('swapDirectionBtn'); const swapFromBalanceEl = document.getElementById('swapFromBalance'); const swapToBalanceEl = document.getElementById('swapToBalance'); const depositChatIdEl = document.getElementById('depositChatId'); const depositMessage = document.getElementById('depositMessage'); const copyFeedbackDepositEl = document.getElementById('copyFeedbackDeposit'); const selectSendTokenBtn = document.getElementById('selectSendTokenBtn'); const sendAmountInput = document.getElementById('sendAmount'); const recipientIdInput = document.getElementById('recipientId'); const sendButton = document.getElementById('sendButton'); const sendMessage = document.getElementById('sendMessage'); const sendAvailableBalanceEl = document.getElementById('sendAvailableBalance'); const sendUsdValueInfoEl = document.getElementById('sendUsdValueInfo'); const tokenSelectorOverlay = document.getElementById('tokenSelectorOverlay'); const tokenSelectorModal = document.getElementById('tokenSelectorModal'); const modalTitle = document.getElementById('modalTitle'); const modalCloseBtn = document.getElementById('modalCloseBtn'); const modalSearchInput = document.getElementById('modalSearchInput'); const modalTokenList = document.getElementById('modalTokenList');

        // --- UTILITY FUNCTIONS ---
        function showLoading(show, text = 'Loading...') { /* ... */ }
        function showMessage(element, message, type = 'error', duration = 5000) { /* ... */ }
        function showGlobalMessage(message, type = 'error', duration = 5000) { /* ... */ }
        function formatCurrency(amount, decimals = 2) { const num = parseFloat(amount); return isNaN(num) ? '0.00' : num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
        function formatTokenAmount(amount, decimals = 6) { const num = parseFloat(amount); if (isNaN(num)) return '0'; let effectiveDecimals = decimals; if (num > 0) { if (num > 1000) effectiveDecimals = 2; else if (num > 1) effectiveDecimals = 4; else if (num < 0.0001) effectiveDecimals = 8; } else { effectiveDecimals = 2; } effectiveDecimals = Math.min(decimals, effectiveDecimals); return num.toLocaleString(undefined, { minimumFractionDigits: Math.min(2, effectiveDecimals) , maximumFractionDigits: effectiveDecimals }); }
        function triggerHapticFeedback(style = 'medium') { /* ... */ }
        const tinycolor = window.tinycolor || function(color) { /* Basic fallback */ return { darken: () => color, lighten: () => color, setAlpha: (a) => `rgba(255, 255, 255, ${a})`, toString: () => color, toRgb: () => ({ r: 0, g: 0, b: 0}) }; }; // Added basic toRgb

        // --- NEW: Formatting function for K/M/B/T ---
        function formatDisplayNumber(num, type = 'token') {
             num = parseFloat(num);
             if (isNaN(num)) return type === 'usd' ? '$0.00' : '0';
             if (num === 0) return type === 'usd' ? '$0.00' : '0';

             const absNum = Math.abs(num);
             const prefix = type === 'usd' ? '$' : '';
             const decimals = 1; // Decimals for K, M, B, T

             const tiers = [
                 { value: 1e12, symbol: "T" },
                 { value: 1e9,  symbol: "B" },
                 { value: 1e6,  symbol: "M" },
                 { value: 1e3,  symbol: "K" }
             ];

             for (let i = 0; i < tiers.length; i++) {
                 if (absNum >= tiers[i].value) {
                     let formatted = (num / tiers[i].value).toFixed(decimals);
                     formatted = formatted.replace(/\.0$/, ''); // Remove trailing .0
                     return prefix + formatted + tiers[i].symbol;
                 }
             }

             // Fallback for numbers < 1000
             if (type === 'usd') {
                 return prefix + formatCurrency(num); // Use existing precise USD formatting
             } else {
                 return formatTokenAmount(num); // Use existing precise token formatting
             }
         }

        function applyTheme(params) {
             if (!params) return;
             const root = document.documentElement;
             const setProp = (prop, value) => root.style.setProperty(prop, value);
             // Define fallbacks
             const bgColor = params.bg_color || '#121212'; const textColor = params.text_color || '#ffffff'; const hintColor = params.hint_color || '#b3b3b3'; const linkColor = params.link_color || '#8774e1'; const buttonColor = params.button_color || '#1DB954'; const buttonTextColor = params.button_text_color || '#ffffff'; const secondaryBgColor = params.secondary_bg_color || '#1e1e1e';
             // Apply basic colors
             setProp('--bg-color', bgColor); setProp('--primary-text', textColor); setProp('--secondary-text', hintColor); setProp('--link-color', linkColor); setProp('--button-bg', buttonColor); setProp('--button-text', buttonTextColor); setProp('--accent-color', buttonColor); setProp('--card-bg', secondaryBgColor);
             // Derive other colors
             const inputBg = tinycolor(secondaryBgColor).darken(5).toString(); const borderColor = tinycolor(secondaryBgColor).lighten(10).toString(); const hoverBg = tinycolor(textColor).setAlpha(0.07).toString(); const modalBg = tinycolor(bgColor).lighten(8).toString(); // Slightly lighter modal
             setProp('--input-bg', inputBg); setProp('--border-color', borderColor); setProp('--hover-bg', hoverBg); setProp('--modal-bg', modalBg);
             // Set fixed colors
             setProp('--receive-color', '#4caf50'); setProp('--send-color', '#f44336'); setProp('--swap-color', '#ff9800'); setProp('--warning-color', '#ffa726');
             // Set Accent RGB for RGBA usage (focus ring)
             const accentRgb = tinycolor(buttonColor).toRgb();
             setProp('--accent-rgb', `${accentRgb.r}, ${accentRgb.g}, ${accentRgb.b}`);

             // Apply to body
             document.body.style.backgroundColor = bgColor; document.body.style.color = textColor;
             // Apply to TG UI
             if (tg && tg.setHeaderColor) try { tg.setHeaderColor(secondaryBgColor); } catch(e) { console.warn("Failed to set header color", e);}
             if (tg && tg.setBackgroundColor) try { tg.setBackgroundColor(bgColor); } catch(e) { console.warn("Failed to set background color", e);}
         }

        // --- PAGE NAVIGATION ---
        function showPage(pageId) { /* ... (Keep existing logic) ... */ }

        // --- FIREBASE FUNCTIONS ---
        function initializeFirebase() { /* ... */ return new Promise((resolve, reject) => { if (firebaseInitialized) { resolve(); return; } try { if (typeof firebase === 'undefined' || !firebase.app || !firebase.database) throw new Error("SDK not loaded."); if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); else firebase.app(); db = firebase.database(); firebaseInitialized = true; console.log("Firebase Connected"); resolve(); } catch (error) { console.error("Firebase Init Error:", error); showGlobalMessage("Error connecting to database.", "error", 0); reject(error); } }); }
        function getTokenData() { /* ... */ if (!db) return Promise.reject("DB not available."); const ref = db.ref('tokens'); return ref.once('value').then(snap => { tokenData = snap.val() || {}; if (!tokenData.USDT) tokenData.USDT = { name: "Tether USD", priceUSD: 1.00, logoUrl: `https://via.placeholder.com/40/26A17B/ffffff?text=USDT` }; else tokenData.USDT.priceUSD = 1.00; console.log("Token data loaded:", Object.keys(tokenData).length); return tokenData; }).catch(err => { console.error("Token fetch error:", err); showGlobalMessage("Failed to load token info.", "error"); tokenData = { USDT: { name: "Tether USD", priceUSD: 1.00, logoUrl: `https://via.placeholder.com/40/26A17B/ffffff?text=USDT` } }; return tokenData; }); }
        async function performSwapTransaction(userId, updates, txRecord) { /* ... (Keep existing logic) ... */ }
        async function performP2PTransfer(senderId, recipientId, asset, amount) { /* ... (Keep existing logic) ... */ }
        function getUserDataRealtime(userId) { /* ... (Keep existing logic with 0.1 USDT initial) ... */ }

        // --- UI UPDATE FUNCTIONS (Modified for formatDisplayNumber) ---
        function updateHomePageUI() {
             if (!currentUser || !welcomeMessageEl) return;
             welcomeMessageEl.textContent = `Welcome, ${currentUser.first_name || 'User'}!`;
             userFirstNameEl.textContent = currentUser.first_name || '-'; userLastNameEl.textContent = currentUser.last_name || '-'; userUsernameEl.textContent = currentUser.username ? `@${currentUser.username}` : '(No username)'; userChatIdEl.textContent = currentUser.id || 'N/A';

             let totalUsdValue = 0;
             assetListEl.innerHTML = '';
             const sortedBalances = Object.entries(userBalance)
                 .map(([asset, balance]) => ({ asset, balance: parseFloat(balance || 0), tokenInfo: tokenData[asset], priceUsd: parseFloat(tokenData[asset]?.priceUSD || (asset === 'USDT' ? 1 : 0)) }))
                 .filter(item => item.balance > 0.0000001 || item.asset === 'USDT') // Show USDT even if 0, hide dust slightly higher threshold
                 .map(item => ({ ...item, usdValue: item.balance * item.priceUsd }))
                 .sort((a, b) => { if (b.usdValue !== a.usdValue) return b.usdValue - a.usdValue; return (a.tokenInfo?.name || a.asset).localeCompare(b.tokenInfo?.name || b.asset); });

             if (sortedBalances.length === 0) {
                 assetListEl.innerHTML = '<li style="color: var(--secondary-text); text-align: center; padding: 30px 0; border: none;">You have no assets yet.</li>';
             } else {
                 sortedBalances.forEach(item => {
                    totalUsdValue += item.usdValue;
                    const li = document.createElement('li');
                    li.className = 'token-list-item';
                    li.innerHTML = `
                        <div class="token-info">
                            <img src="${item.tokenInfo?.logoUrl || `https://via.placeholder.com/40/333333/ffffff?text=${item.asset.substring(0,1)}`}" alt="${item.asset}">
                            <div class="token-name-symbol">
                                <div class="token-name">${item.tokenInfo?.name || item.asset}</div>
                                <div class="token-symbol">${item.asset}</div>
                            </div>
                        </div>
                        <div class="token-balance">
                            <div class="balance-amount">${formatDisplayNumber(item.balance, 'token')}</div>
                            ${item.usdValue > 0.01 ? `<div class="balance-usd">≈ ${formatDisplayNumber(item.usdValue, 'usd')}</div>` : ''}
                        </div>
                    `;
                    assetListEl.appendChild(li);
                 });
             }
             totalBalanceEl.innerHTML = `${formatDisplayNumber(totalUsdValue, 'usd')} <span>USD</span>`; // Use new formatter
             updateTransactionHistory();
         }

        function updateTransactionHistory() {
             if (!transactionListEl) return;
             transactionListEl.innerHTML = '';
             const txArray = Object.entries(userTransactions || {}) .map(([key, value]) => ({ id: key, ...value })) .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

             if (txArray.length === 0) { transactionListEl.innerHTML = '<li style="color: var(--secondary-text); text-align: center; border: none; padding: 30px 0;">No transaction history.</li>'; return; }

             txArray.slice(0, 30).forEach(tx => {
                 const li = document.createElement('li');
                 li.classList.add(tx.type || 'unknown');
                 let iconSvg = ''; let mainInfoHtml = ''; let peerInfoHtml = '';
                 const amountFormatted = formatDisplayNumber(tx.amount || tx.fromAmount || 0, 'token'); // Use new formatter
                 const assetSymbol = tx.asset || tx.fromAsset || '?';
                 const toAmountFormatted = tx.toAmount ? formatDisplayNumber(tx.toAmount, 'token') : ''; // Use new formatter
                 const toAssetSymbol = tx.toAsset || '';

                  switch (tx.type) {
                      case 'receive':
                          iconSvg = `<svg class="tx-type-icon" style="color: var(--receive-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M11 15h2v-4h4v-2h-4V5h-2v4H7v2h4v4zm1-13C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>`;
                          mainInfoHtml = `Received <span class="tx-amount">${amountFormatted}</span><span class="tx-asset">${assetSymbol}</span>`;
                          peerInfoHtml = `<span class="tx-peer">From: <strong>${tx.fromUserId || 'Unknown'}</strong></span>`;
                          break;
                      case 'send':
                           iconSvg = `<svg class="tx-type-icon" style="color: var(--send-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.7-.3.7-1.2 0-1.5L3.4 2.1c-.6-.3-1.3.1-1.3.8l.9 6.5c0 .5.5.9 1 .9h6.4c.4 0 .6.5.3.8l-2.6 2.1c-.4.3-.4.9 0 1.2l2.6 2.1c.3.3.1.8-.3.8H4c-.5 0-1 .4-1 .9l-.9 6.5c0 .6.7 1.1 1.3.8z"></path></svg>`;
                           mainInfoHtml = `Sent <span class="tx-amount">${amountFormatted}</span><span class="tx-asset">${assetSymbol}</span>`;
                           peerInfoHtml = `<span class="tx-peer">To: <strong>${tx.toUserId || 'Unknown'}</strong></span>`;
                           break;
                      case 'swap':
                            iconSvg = `<svg class="tx-type-icon" style="color: var(--swap-color);" viewBox="0 0 24 24" fill="currentColor"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>`;
                           // Group swap info better
                          mainInfoHtml = `Swap <span class="tx-amount">${amountFormatted}</span><span class="tx-asset">${assetSymbol}</span> → <span class="tx-amount">${toAmountFormatted}</span><span class="tx-asset">${toAssetSymbol}</span>`;
                          if (tx.effectiveRate && tx.fromAsset && tx.toAsset) {
                               peerInfoHtml = `<span class="tx-peer">Rate: ≈ ${formatTokenAmount(tx.effectiveRate, 5)} ${tx.toAsset}/${tx.fromAsset}</span>`; // Keep rate precise
                           } else { peerInfoHtml = `<span class="tx-peer">Swap processed</span>`; }
                          break;
                      default:
                           iconSvg = `<svg class="tx-type-icon" style="color: var(--secondary-text);" viewBox="0 0 24 24" fill="currentColor"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/></svg>`;
                           mainInfoHtml = `System <span class="tx-amount">${amountFormatted}</span><span class="tx-asset">${assetSymbol}</span>`;
                           peerInfoHtml = `<span class="tx-peer">Type: ${tx.type || 'Unknown'}</span>`;
                 }
                 const timestampStr = tx.timestamp ? new Date(tx.timestamp).toLocaleString([], { day: '2-digit', month: 'short', hour: '2-digit', minute:'2-digit', hour12: false }) : 'Pending';
                 const txIdHtml = tx.id ? `<span class="tx-id" title="Click to copy Tx ID: ${tx.id}" onclick="copyTextToClipboard('${tx.id}', 'Transaction ID')">TxID: ${tx.id.substring(0, 6)}...${tx.id.substring(tx.id.length - 4)}</span>` : '';

                 li.innerHTML = `
                    <div class="tx-details">
                        ${iconSvg}
                        <div class="tx-desc"> <!-- New wrapper -->
                             ${mainInfoHtml}
                             ${peerInfoHtml}
                             ${txIdHtml}
                        </div>
                    </div>
                    <div class="tx-timestamp">${timestampStr}</div>
                 `;
                 transactionListEl.appendChild(li);
             });
        }

        // --- Token Modal Functions ---
        function openTokenSelector(context) { /* ... (Keep existing logic) ... */ }
        function closeTokenSelector() { /* ... (Keep existing logic) ... */ }
        function populateTokenList() {
             modalTokenList.innerHTML = '';
             const searchTerm = modalSearchInput.value.toLowerCase().trim();
             let tokensToShow = Object.entries(tokenData);
             if (currentModalContext === 'send') { tokensToShow = tokensToShow.filter(([symbol]) => parseFloat(userBalance[symbol] || 0) > 0.0000001); }
             if (searchTerm) { tokensToShow = tokensToShow.filter(([symbol, data]) => symbol.toLowerCase().includes(searchTerm) || (data.name || '').toLowerCase().includes(searchTerm)); }
             tokensToShow.sort(([, dataA], [, dataB]) => (dataA.name || '').localeCompare(dataB.name || ''));

             if (tokensToShow.length === 0) { modalTokenList.innerHTML = `<li class="modal-list-empty">${searchTerm ? 'No matching tokens found.' : 'No tokens available.'}</li>`; return; }

             const selectedFromToken = selectFromTokenBtn.dataset.token; const selectedToToken = selectToTokenBtn.dataset.token; const selectedSendToken = selectSendTokenBtn.dataset.token;

             tokensToShow.forEach(([symbol, data]) => {
                 const li = document.createElement('li');
                 li.className = 'modal-token-list-item';
                 li.dataset.symbol = symbol;
                 const balance = parseFloat(userBalance[symbol] || 0);
                 const priceUsd = parseFloat(data.priceUSD || (symbol === 'USDT' ? 1 : 0));
                 const balanceUsdValue = balance * priceUsd;
                 let balanceHtml = '';
                 if (currentModalContext === 'send') {
                      balanceHtml = `
                          <div class="token-balance">
                              <div class="balance-amount">${formatDisplayNumber(balance, 'token')}</div> <!-- Use new formatter -->
                              ${balanceUsdValue > 0.01 ? `<div class="balance-usd">≈ ${formatDisplayNumber(balanceUsdValue, 'usd')}</div>` : ''} <!-- Use new formatter -->
                          </div>`;
                  }
                 li.innerHTML = `
                     <div class="token-info">
                         <img src="${data.logoUrl || `https://via.placeholder.com/40/333333/ffffff?text=${symbol.substring(0,1)}`}" alt="${symbol}">
                         <div class="token-name-symbol">
                             <div class="token-name">${data.name || symbol}</div>
                             <div class="token-symbol">${symbol}</div>
                         </div>
                     </div>
                     ${balanceHtml}`;

                 let isDisabled = false;
                 if (currentModalContext === 'swap-from' && symbol === selectedToToken) isDisabled = true;
                 if (currentModalContext === 'swap-to' && symbol === selectedFromToken) isDisabled = true;
                 if (currentModalContext === 'swap-from' && symbol === selectedFromToken) isDisabled = true;
                 if (currentModalContext === 'swap-to' && symbol === selectedToToken) isDisabled = true;
                 if (currentModalContext === 'send' && symbol === selectedSendToken) isDisabled = true;

                 if (isDisabled) { li.classList.add('disabled'); li.title = `Token already selected`; }
                 else { li.addEventListener('click', () => handleTokenSelection(symbol)); }
                 modalTokenList.appendChild(li);
             });
         }
        function handleTokenSelection(symbol) { /* ... (Keep existing logic) ... */ }

        // --- UPDATE UI Functions (Modified for formatDisplayNumber) ---
        function updateSwapUI() {
             const fromAsset = selectFromTokenBtn.dataset.token; const toAsset = selectToTokenBtn.dataset.token;
             if (!fromAmountInput || !toAmountInput || !swapFromBalanceEl || !swapToBalanceEl || !swapButton || !tokenData) return;

             const fromAmount = Math.max(0, parseFloat(fromAmountInput.value || 0));
             const fromBalance = parseFloat(userBalance[fromAsset] || 0);
             const toBalance = parseFloat(userBalance[toAsset] || 0);

             // Use new formatter for balance display
             swapFromBalanceEl.textContent = fromAsset ? `${formatDisplayNumber(fromBalance, 'token')} ${fromAsset}` : '0.00';
             swapToBalanceEl.textContent = toAsset ? `${formatDisplayNumber(toBalance, 'token')} ${toAsset}` : '0.00';

             updateSwapRateAndToAmount();

             const calculatedToAmount = parseFloat(toAmountInput.value || 0);
             const hasSufficientBalance = fromBalance >= fromAmount;
             const isValidAmount = fromAmount > 0;
             const areTokensSelected = fromAsset && toAsset;
             const areTokensDifferent = fromAsset !== toAsset;
             const isRateAvailable = calculatedToAmount > 0;

             let meetsMinValue = true; let minSwapWarning = ''; let fromAmountUsdValue = 0;
             if (isValidAmount && fromAsset && tokenData[fromAsset]) {
                 const priceUsd = parseFloat(tokenData[fromAsset].priceUSD || 0);
                 if (priceUsd > 0) {
                     fromAmountUsdValue = fromAmount * priceUsd;
                     if (fromAmountUsdValue < MIN_SWAP_USD_VALUE) {
                         meetsMinValue = false;
                         minSwapWarning = `Min swap: ≈ ${formatDisplayNumber(MIN_SWAP_USD_VALUE, 'usd')}.`; // Use new formatter
                     }
                 }
             }

             const feePercentDisplay = (SWAP_FEE_PERCENT * 100).toFixed(1) + '%'; // Use 1 decimal for fee %
             let feeInfoText = `Fee: ${feePercentDisplay}. `;
             if (!meetsMinValue) {
                 feeInfoText += minSwapWarning;
                 swapFeeInfoEl.classList.add('warning');
             } else {
                 swapFeeInfoEl.classList.remove('warning');
             }
             // Only show detailed fee amount if tokens are selected
             if (areTokensSelected && areTokensDifferent && fromAmount > 0 && isRateAvailable) {
                  const fromPrice = parseFloat(tokenData[fromAsset]?.priceUSD || 0);
                  const toPrice = parseFloat(tokenData[toAsset]?.priceUSD || 0);
                  if(fromPrice > 0 && toPrice > 0) {
                      const feeAmount = (fromAmount * fromPrice / toPrice) * SWAP_FEE_PERCENT;
                      // Show fee amount only if significant
                      if (feeAmount > 0.000001) {
                           feeInfoText = `Fee: ${formatDisplayNumber(feeAmount, 'token')} ${toAsset} (${feePercentDisplay}). ` + minSwapWarning;
                      }
                  }
             }
             swapFeeInfoEl.textContent = feeInfoText.trim();

             const canSwap = areTokensSelected && areTokensDifferent && isValidAmount && hasSufficientBalance && isRateAvailable && meetsMinValue;
             swapButton.disabled = !canSwap;

             // Manage messages
             if (areTokensSelected && areTokensDifferent && isValidAmount) {
                  if (!hasSufficientBalance) { showMessage(swapMessage, `Insufficient ${fromAsset} balance`, 'error', 4000); triggerHapticFeedback('error'); }
                  else if (swapMessage.style.display !== 'none' && swapMessage.textContent.includes('Insufficient')) { swapMessage.style.display = 'none'; }
             } else if (swapMessage.style.display !== 'none' && swapMessage.textContent.includes('Insufficient')) { swapMessage.style.display = 'none'; }
        }

        function updateSwapRateAndToAmount() {
             const fromAsset = selectFromTokenBtn.dataset.token; const toAsset = selectToTokenBtn.dataset.token;
             const fromAmount = parseFloat(fromAmountInput.value || 0);

             toAmountInput.value = ''; swapRateEl.textContent = 'Select tokens and enter amount'; // Updated default text
             // swapFeeInfoEl cleared/updated in updateSwapUI

             if (!fromAsset || !toAsset || !tokenData[fromAsset] || !tokenData[toAsset]) { swapRateEl.textContent = 'Select valid tokens'; return; }
             if (fromAsset === toAsset) { swapRateEl.textContent = 'Cannot swap the same token'; return; }

             const fromPrice = parseFloat(tokenData[fromAsset].priceUSD || 0); const toPrice = parseFloat(tokenData[toAsset].priceUSD || 0);
             if (fromPrice <= 0 || toPrice <= 0) { swapRateEl.textContent = 'Price info unavailable'; toAmountInput.value = '0'; return; }

             const baseRate = fromPrice / toPrice;
             swapRateEl.textContent = `1 ${fromAsset} ≈ ${formatTokenAmount(baseRate, 5)} ${toAsset}`; // Keep rate precise

             if (isNaN(fromAmount) || fromAmount <= 0) { return; } // No calculation needed if amount invalid

             const fromUsdValue = fromAmount * fromPrice;
             const toAmountBeforeFee = fromUsdValue / toPrice;
             const feeAmount = toAmountBeforeFee * SWAP_FEE_PERCENT; // Fee in 'to' asset
             const calculatedToAmount = toAmountBeforeFee - feeAmount;

             // Display 'to' amount using precise formatting, not K/M/B/T for output field
             toAmountInput.value = (isNaN(calculatedToAmount) || calculatedToAmount < 0) ? '0' : formatTokenAmount(calculatedToAmount, 8);
         }

        function updateSendForm() {
             const selectedAsset = selectSendTokenBtn.dataset.token;
             if (!sendAmountInput || !recipientIdInput || !sendAvailableBalanceEl || !sendUsdValueInfoEl || !sendButton || !tokenData || !currentUser) return;

             const availableBalance = parseFloat(userBalance[selectedAsset] || 0);
             const sendAmount = Math.max(0, parseFloat(sendAmountInput.value || 0));
             const recipientId = recipientIdInput.value.trim();

             sendAvailableBalanceEl.textContent = selectedAsset ? `${formatDisplayNumber(availableBalance, 'token')} ${selectedAsset}` : '0.00'; // Use new formatter

             let usdValue = 0; let priceUsd = 0; let usdValueText = '≈ $0.00 USD'; let isBelowMin = false;
             sendUsdValueInfoEl.classList.remove('warning');

             if (selectedAsset && tokenData[selectedAsset]) {
                 priceUsd = parseFloat(tokenData[selectedAsset].priceUSD || 0);
                 if (priceUsd > 0) {
                     usdValue = sendAmount * priceUsd;
                     usdValueText = `≈ ${formatDisplayNumber(usdValue, 'usd')}`; // Use new formatter
                     if (sendAmount > 0 && usdValue < MIN_SEND_USD_VALUE) {
                         isBelowMin = true;
                         usdValueText += ` (Min ${formatDisplayNumber(MIN_SEND_USD_VALUE, 'usd')})`; // Use new formatter
                         sendUsdValueInfoEl.classList.add('warning');
                     }
                 } else if (sendAmount > 0) { usdValueText = `USD value unavailable`; sendUsdValueInfoEl.classList.add('warning'); }
             } else if (sendAmount > 0) { usdValueText = `Select asset first`; }

             sendUsdValueInfoEl.textContent = usdValueText;

             const isValidRecipient = /^\d+$/.test(recipientId) && recipientId.length > 3;
             const isNotSendingToSelf = recipientId !== String(currentUser.id);
             const hasSufficientBalance = availableBalance >= sendAmount;
             const isValidAmount = sendAmount > 0;
             const meetsMinValue = !isBelowMin || sendAmount === 0;
             const canSend = selectedAsset && isValidAmount && isValidRecipient && isNotSendingToSelf && hasSufficientBalance && meetsMinValue && priceUsd > 0;
             sendButton.disabled = !canSend;

             // Clear messages logic remains the same
             if (sendMessage.style.display !== 'none' && sendMessage.classList.contains('error')) { /* ... */ }
        }

        function updateDepositPageUI() { /* ... (Keep existing logic) ... */ }
        function copyTextToClipboard(text, contentType = 'Chat ID') { /* ... (Keep existing logic) ... */ }

        // --- ACTION HANDLERS (Modified for new formatters in messages) ---
        async function handleSwap() {
             const fromAsset = selectFromTokenBtn.dataset.token; const toAsset = selectToTokenBtn.dataset.token;
             const fromAmount = parseFloat(fromAmountInput.value); const toAmount = parseFloat(toAmountInput.value);

             // Re-validate
             if (!currentUser || !fromAsset || !toAsset || fromAsset === toAsset || isNaN(fromAmount) || fromAmount <= 0 || isNaN(toAmount) /* Don't check toAmount > 0 here */) { showMessage(swapMessage, "Invalid swap details.", "error"); return; }
             const fromBalance = parseFloat(userBalance[fromAsset] || 0); if (fromBalance < fromAmount) { showMessage(swapMessage, `Insufficient ${fromAsset} balance.`, "error"); return; }
             const fromPrice = parseFloat(tokenData[fromAsset]?.priceUSD || 0); const toPrice = parseFloat(tokenData[toAsset]?.priceUSD || 0); if (fromPrice <= 0 || toPrice <= 0) { showMessage(swapMessage, "Price info missing.", "error"); return; }
             const fromAmountUsdValue = fromAmount * fromPrice; if (fromAmountUsdValue < MIN_SWAP_USD_VALUE) { showMessage(swapMessage, `Swap amount below min ≈ ${formatDisplayNumber(MIN_SWAP_USD_VALUE, 'usd')}.`, "error", 5000); return; }

             showLoading(true, 'Processing Swap...'); swapButton.disabled = true; triggerHapticFeedback('light');

             try {
                 // Recalculate final amounts just before sending
                 const baseRate = fromPrice / toPrice; const fromUsdValueRecalc = fromAmount * fromPrice; const toAmountBeforeFeeRecalc = fromUsdValueRecalc / toPrice; const feeAmountRecalc = toAmountBeforeFeeRecalc * SWAP_FEE_PERCENT; const finalToAmountRecalc = toAmountBeforeFeeRecalc - feeAmountRecalc; const effectiveRateRecalc = (fromAmount > 0) ? finalToAmountRecalc / fromAmount : 0;
                 if (isNaN(finalToAmountRecalc) || finalToAmountRecalc <= 0) { throw new Error("Calculated receive amount is invalid."); } // Final check

                 const balanceUpdates = { [fromAsset]: -fromAmount, [toAsset]: finalToAmountRecalc };
                 const txRecord = { type: "swap", fromAsset, fromAmount, toAsset, toAmount: finalToAmountRecalc, rate: baseRate, effectiveRate: effectiveRateRecalc, fee: feeAmountRecalc, feeAsset: toAsset, status: "completed" };

                 await performSwapTransaction(currentUser.id, balanceUpdates, txRecord);

                 // Use new formatters in success message
                 showMessage(swapMessage, `Swapped ${formatDisplayNumber(fromAmount, 'token')} ${fromAsset} for ≈ ${formatDisplayNumber(finalToAmountRecalc, 'token')} ${toAsset}!`, "success", 5000);
                 triggerHapticFeedback('success');
                 fromAmountInput.value = '';

             } catch (error) { console.error("Swap Error:", error); showMessage(swapMessage, `Swap failed: ${error.message || "Please try again."}`, "error"); triggerHapticFeedback('error'); }
             finally { showLoading(false); /* updateSwapUI triggered by listener */ }
         }

        async function handleSend() {
             const asset = selectSendTokenBtn.dataset.token; const amount = parseFloat(sendAmountInput.value); const recipientId = recipientIdInput.value.trim();

             // Re-validate
             if (!currentUser || !asset || isNaN(amount) || amount <= 0 || !recipientId) { showMessage(sendMessage, "Please select asset and fill fields.", "error"); return; }
             if (!/^\d+$/.test(recipientId) || recipientId.length <= 3) { showMessage(sendMessage, "Invalid Recipient ID.", "error"); return; }
             const senderId = String(currentUser.id); if (recipientId === senderId) { showMessage(sendMessage, "Cannot send to yourself.", "error"); return; }
             const balance = parseFloat(userBalance[asset] || 0); if (balance < amount) { showMessage(sendMessage, `Insufficient ${asset} balance.`, "error"); return; }
             const priceUsd = parseFloat(tokenData[asset]?.priceUSD || 0); if (priceUsd <= 0) { showMessage(sendMessage, `Cannot send ${asset}, price unavailable.`, "error"); return; }
             const usdValue = amount * priceUsd; if (usdValue < MIN_SEND_USD_VALUE) { showMessage(sendMessage, `Send amount below min $${formatCurrency(MIN_SEND_USD_VALUE)}.`, "error", 6000); return; }

             showLoading(true, 'Processing Transfer...'); sendButton.disabled = true; triggerHapticFeedback('light');

             try {
                 await performP2PTransfer(senderId, recipientId, asset, amount);
                 // Use new formatter in success message
                 showMessage(sendMessage, `Sent ${formatDisplayNumber(amount, 'token')} ${asset} to user ${recipientId}.`, "success", 5000);
                 triggerHapticFeedback('success');
                 sendAmountInput.value = ''; recipientIdInput.value = '';
                 const sendButtonInfo = selectSendTokenBtn.querySelector('.selected-token-info'); sendButtonInfo.innerHTML = `<span class="select-prompt">Select Asset to Send</span>`; selectSendTokenBtn.dataset.token = '';
                 updateSendForm();

             } catch (error) { console.error("Send Error:", error); triggerHapticFeedback('error'); if (error.code === "RECIPIENT_NOT_FOUND") { showMessage(sendMessage, error.message, "error", 6000); } else if (error.message.includes("permission_denied")) { showMessage(sendMessage, `Transfer permission error.`, "error", 6000); } else { showMessage(sendMessage, `Send failed: ${error.message || "Unknown error."}`, "error", 6000); } }
             finally { showLoading(false); /* updateSendForm called manually */ }
         }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() { /* ... (Keep existing setup, including modal listeners) ... */ }

        // --- INITIALIZATION ---
        async function initializeApp() { /* ... (Keep existing logic) ... */ }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
