<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Explorer</title>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- Basic Reset & Body Styling --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        /* --- Main Container --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff; /* White card background */
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1a237e; /* Dark blue header */
        }

        /* --- Loading Indicator --- */
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #555;
            padding: 40px 0;
        }

        /* --- Coin List Styling --- */
        #coin-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 20px;
        }

        /* --- Individual Coin Card Styling --- */
        .coin-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }

        .coin-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .coin-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .coin-logo {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            border-radius: 50%;
            object-fit: contain; /* Ensure logo fits well */
            background-color: #eee; /* Placeholder bg if image fails */
        }

        .coin-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50; /* Darker text color */
        }

        .coin-symbol {
            font-size: 0.9em;
            color: #7f8c8d; /* Greyish color for symbol */
            margin-left: 8px;
        }

        .coin-details {
           margin-bottom: 15px; /* Space before chart */
        }

        .coin-price {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e; /* Default price color */
            display: flex; /* Align price and change */
            align-items: baseline; /* Align text nicely */
            gap: 10px; /* Space between price and change % */
        }

        .price-change {
            font-size: 1em;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff; /* Text color for change */
        }

        /* --- Price Change Colors --- */
        .price-up {
            color: #2ecc71; /* Green */
        }
        .price-down {
            color: #e74c3c; /* Red */
        }
        .change-up {
            background-color: #2ecc71; /* Green background */
        }
        .change-down {
            background-color: #e74c3c; /* Red background */
        }
        .change-neutral {
            background-color: #95a5a6; /* Grey background */
            color: #fff;
        }
        .arrow {
            display: inline-block;
            margin-right: 3px;
        }

        /* --- Chart Styling --- */
        .chart-container {
            width: 100%;
            height: 150px; /* Fixed height for charts */
            margin-top: auto; /* Pushes chart to bottom if card grows */
        }

         /* --- Footer/Info --- */
         .info {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #777;
         }
         .info a {
            color: #3498db;
            text-decoration: none;
         }
         .info a:hover {
            text-decoration: underline;
         }
         .warning {
            color: #e74c3c;
            font-weight: bold;
         }

    </style>
</head>
<body>

    <div class="container">
        <h1>Crypto Price Explorer</h1>

        <!-- Loading Indicator -->
        <div id="loading">Loading coin data...</div>

        <!-- Coin List Container -->
        <div id="coin-list">
            <!-- Coin cards will be injected here by JavaScript -->
        </div>

        <div class="info">
            Data updates in real-time from Firebase. Chart shows price history during this session only.
            <br>
            <span class="warning">Warning:</span> Ensure your Firebase Security Rules are properly configured to protect your data. Public rules are insecure.
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        // WARNING: It's generally better to hide API keys, but required here for single-file demo.
        // **IMPORTANT**: SECURE YOUR FIREBASE RULES IN THE CONSOLE!
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg", // Replace if needed, but use securely!
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.firebasestorage.app",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- Initialize Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const tokensRef = database.ref('tokens');

            // --- Global State ---
            const coinDataStore = {}; // Stores { symbol: { currentData: {}, previousPrice: null, chart: null, chartData: { labels: [], prices: [] } } }
            const MAX_CHART_POINTS = 30; // Max data points to show on chart

            // --- DOM Elements ---
            const coinListContainer = document.getElementById('coin-list');
            const loadingIndicator = document.getElementById('loading');

            // --- Chart Colors ---
            const chartGreen = 'rgba(46, 204, 113, 0.6)';
            const chartRed = 'rgba(231, 76, 60, 0.6)';
            const chartNeutral = 'rgba(149, 165, 166, 0.6)';
            const chartBorder = 'rgba(52, 73, 94, 1)';


            // --- Functions ---

            /**
             * Formats number as USD currency.
             * @param {number} number - The number to format.
             * @returns {string} Formatted currency string.
             */
            function formatCurrency(number) {
                if (typeof number !== 'number') return '$--';
                 // Adjust decimals based on price magnitude
                const options = {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: number < 0.1 ? 4 : 2,
                    maximumFractionDigits: number < 0.01 ? 8 : (number < 1 ? 4 : 2)
                };
                return number.toLocaleString('en-US', options);
            }

             /**
             * Renders or updates a coin card in the DOM.
             * @param {string} symbol - The coin symbol (e.g., 'ABS').
             * @param {object} coin - The coin data object from Firebase.
             */
            function renderCoinCard(symbol, coin) {
                let card = document.getElementById(`coin-${symbol}`);
                let priceElement;
                let changeElement;

                const previousPrice = coinDataStore[symbol]?.previousPrice;
                const currentPrice = coin.priceUSD;
                let priceChange = 0;
                let priceChangePercent = 0;
                let priceClass = '';
                let changeClass = 'change-neutral';
                let arrow = '';


                if (typeof previousPrice === 'number' && typeof currentPrice === 'number' && previousPrice !== 0) {
                    priceChange = currentPrice - previousPrice;
                    priceChangePercent = (priceChange / previousPrice) * 100;

                    if (priceChange > 0) {
                        priceClass = 'price-up';
                        changeClass = 'change-up';
                        arrow = '<span class="arrow">▲</span>';
                    } else if (priceChange < 0) {
                        priceClass = 'price-down';
                        changeClass = 'change-down';
                        arrow = '<span class="arrow">▼</span>';
                    }
                }

                 // Create new card if it doesn't exist
                if (!card) {
                    card = document.createElement('div');
                    card.className = 'coin-card';
                    card.id = `coin-${symbol}`;
                    card.innerHTML = `
                        <div class="coin-header">
                            <img src="${coin.logoUrl || 'placeholder.png'}" alt="${coin.name} Logo" class="coin-logo" onerror="this.style.display='none'">
                            <div>
                                <span class="coin-name">${coin.name || 'N/A'}</span>
                                <span class="coin-symbol">(${symbol})</span>
                            </div>
                        </div>
                        <div class="coin-details">
                             <div class="coin-price">
                                <span class="price-value ${priceClass}"></span>
                                <span class="price-change ${changeClass}"></span>
                             </div>
                             <!-- Add other details here if needed -->
                        </div>
                        <div class="chart-container">
                            <canvas id="chart-${symbol}"></canvas>
                        </div>
                    `;
                    coinListContainer.appendChild(card);
                    // Initialize chart data structure
                    coinDataStore[symbol] = {
                        ...coinDataStore[symbol], // Keep potential existing chart instance
                        chartData: { labels: [], prices: [] }
                    };
                    initializeChart(symbol); // Create the chart instance
                }

                // Update existing card elements
                priceElement = card.querySelector('.price-value');
                changeElement = card.querySelector('.price-change');

                priceElement.textContent = formatCurrency(currentPrice);
                priceElement.className = `price-value ${priceClass}`; // Update class for color

                if (priceChange !== 0) {
                     changeElement.innerHTML = `${arrow}${Math.abs(priceChangePercent).toFixed(2)}%`;
                     changeElement.className = `price-change ${changeClass}`;
                     changeElement.style.display = 'inline-block'; // Show change element
                } else if (previousPrice != null) { // Show neutral only if we have a previous price
                     changeElement.innerHTML = `0.00%`;
                     changeElement.className = `price-change change-neutral`;
                     changeElement.style.display = 'inline-block';
                } else {
                     changeElement.style.display = 'none'; // Hide if no previous price yet
                }


                // Update the store with current data and price for next comparison
                coinDataStore[symbol] = {
                    ...coinDataStore[symbol], // Keep chart instance and data
                    currentData: coin,
                    previousPrice: currentPrice
                };

                 // Update the chart
                updateChart(symbol, currentPrice);
            }

            /**
             * Initializes a Chart.js chart instance for a coin.
             * @param {string} symbol - The coin symbol.
             */
            function initializeChart(symbol) {
                const ctx = document.getElementById(`chart-${symbol}`);
                if (!ctx) return; // Exit if canvas not found

                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: [], // Populated by updateChart
                        datasets: [{
                            label: 'Price (USD)',
                            data: [], // Populated by updateChart
                            borderColor: chartBorder,
                            borderWidth: 2,
                            fill: false, // Don't fill under the line
                            tension: 0.1, // Slightly smooth the line
                            pointRadius: 0, // Hide points for cleaner look
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 200 // Faster animation
                        },
                        scales: {
                            x: {
                                display: false, // Hide X-axis labels (time)
                            },
                            y: {
                                display: true,
                                ticks: {
                                    maxTicksLimit: 5, // Limit Y-axis ticks
                                    callback: function(value, index, values) {
                                        // Simple formatting for Y axis
                                        if (value >= 1) return '$' + value.toFixed(2);
                                        if (value >= 0.01) return '$' + value.toFixed(4);
                                        return '$' + value.toFixed(6);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Hide legend
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) {
                                             label += ': ';
                                         }
                                         if (context.parsed.y !== null) {
                                             label += formatCurrency(context.parsed.y);
                                         }
                                         return label;
                                     }
                                 }
                            }
                        }
                    }
                };

                try {
                     // Destroy existing chart if it exists (e.g., on hot-reload)
                     if (coinDataStore[symbol]?.chart) {
                          coinDataStore[symbol].chart.destroy();
                     }
                    coinDataStore[symbol].chart = new Chart(ctx.getContext('2d'), chartConfig);
                } catch (error) {
                     console.error(`Error initializing chart for ${symbol}:`, error);
                      // Optionally display an error message on the card
                     const chartContainer = ctx.closest('.chart-container');
                     if(chartContainer) chartContainer.innerHTML = `<p style="color: red; font-size: 0.8em;">Chart failed to load.</p>`;
                }
            }


            /**
             * Updates the chart data for a specific coin.
             * @param {string} symbol - The coin symbol.
             * @param {number} newPrice - The latest price.
             */
            function updateChart(symbol, newPrice) {
                const storeEntry = coinDataStore[symbol];
                if (!storeEntry || !storeEntry.chart || typeof newPrice !== 'number') return; // Exit if chart or price invalid

                const chart = storeEntry.chart;
                const chartData = storeEntry.chartData;

                // Add new data point
                const now = new Date(); // Use timestamp for potential tooltip use
                chartData.labels.push(now.toLocaleTimeString()); // Simple time label
                chartData.prices.push(newPrice);

                // Limit history length
                if (chartData.labels.length > MAX_CHART_POINTS) {
                    chartData.labels.shift(); // Remove oldest label
                    chartData.prices.shift(); // Remove oldest price
                }

                // Update chart dataset
                chart.data.labels = chartData.labels;
                chart.data.datasets[0].data = chartData.prices;

                 // Dynamically set border color based on trend (simple version)
                 let borderColor = chartNeutral;
                 if (chartData.prices.length >= 2) {
                    const firstPrice = chartData.prices[0];
                    const lastPrice = chartData.prices[chartData.prices.length - 1];
                    if(lastPrice > firstPrice) borderColor = chartGreen;
                    else if (lastPrice < firstPrice) borderColor = chartRed;
                 }
                  chart.data.datasets[0].borderColor = borderColor;


                // Update the chart
                chart.update('none'); // 'none' prevents jerky animation on every update
            }

            // --- Firebase Data Listener ---
            tokensRef.on('value', (snapshot) => {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
                const tokensData = snapshot.val();

                if (tokensData) {
                    // console.log("Received data:", tokensData); // For debugging

                    // Clear list only if absolutely necessary (causes full redraw)
                    // Instead, we'll update or add cards individually
                    // coinListContainer.innerHTML = ''; // Avoid this if possible for performance

                    const currentSymbols = Object.keys(tokensData);
                    const existingSymbols = Array.from(coinListContainer.children).map(card => card.id.replace('coin-', ''));

                    // Process each token from Firebase
                    for (const symbol in tokensData) {
                        if (tokensData.hasOwnProperty(symbol)) {
                            const coin = tokensData[symbol];
                            // Basic validation
                            if (coin && typeof coin.priceUSD === 'number' && coin.name) {
                                renderCoinCard(symbol, coin);
                            } else {
                                console.warn(`Skipping token ${symbol} due to missing data:`, coin);
                            }
                        }
                    }

                     // Optional: Remove cards for coins that no longer exist in Firebase data
                     existingSymbols.forEach(symbol => {
                         if (!currentSymbols.includes(symbol)) {
                             const cardToRemove = document.getElementById(`coin-${symbol}`);
                             if (cardToRemove) {
                                 // Clean up chart instance and data store
                                 if (coinDataStore[symbol]?.chart) {
                                     coinDataStore[symbol].chart.destroy();
                                 }
                                 delete coinDataStore[symbol];
                                 cardToRemove.remove();
                                 console.log(`Removed card for ${symbol}`);
                             }
                         }
                     });

                } else {
                    coinListContainer.innerHTML = '<p>No token data found in Firebase.</p>';
                    console.warn("No data received from Firebase path 'tokens'.");
                }
            }, (error) => {
                loadingIndicator.style.display = 'none';
                console.error("Firebase read failed: " + error.message);
                coinListContainer.innerHTML = `<p style="color: red;">Error fetching data: ${error.message}</p>`;
            });

        } catch(error) {
             console.error("Error initializing Firebase or script:", error);
             document.getElementById('loading').style.display = 'none';
             document.getElementById('coin-list').innerHTML = `<p style="color: red;">A critical error occurred: ${error.message}</p>`;
        }

    </script>

</body>
</html>
