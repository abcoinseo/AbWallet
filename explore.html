<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Crypto Dashboard</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --bg-color: #131722; /* Dark background */
            --card-bg: #1e222d;  /* Slightly lighter card background */
            --text-color: #d1d4dc; /* Light grey text */
            --text-secondary: #8a8e97; /* Dimmer text */
            --accent-color: #2962ff; /* Blue accent */
            --green: #089981;     /* TradingView green */
            --red: #f23645;       /* TradingView red */
            --border-color: #363a45;
            --font-main: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern Font */
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 25px;
            font-weight: 400; /* Default weight */
        }

        /* --- Main Container --- */
        .container {
            max-width: 1400px; /* Wider container */
            margin: 0 auto;
            padding: 20px; /* Slightly less padding */
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            color: #ffffff; /* White header */
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* --- Loading Indicator --- */
        #loading {
            text-align: center;
            font-size: 1.3em;
            color: var(--text-secondary);
            padding: 50px 0;
            font-weight: 300;
        }

        /* --- Coin Grid --- */
        #coin-list {
            display: grid;
            /* More columns on larger screens */
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px; /* Slightly larger gap */
        }

        /* --- Coin Card --- */
        .coin-card {
            border: 1px solid var(--border-color);
            border-radius: 10px; /* Smoother corners */
            padding: 20px;
            background-color: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
            transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
            display: flex;
            flex-direction: column;
            cursor: pointer; /* Indicate interactivity */
        }

        .coin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(41, 98, 255, 0.15); /* Accent shadow on hover */
            border-color: rgba(41, 98, 255, 0.5); /* Accent border on hover */
        }

        .coin-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .coin-logo {
            width: 45px;
            height: 45px;
            margin-right: 15px;
            border-radius: 50%;
            object-fit: contain;
            background-color: #333; /* Darker placeholder bg */
            border: 2px solid var(--border-color);
        }

        .coin-name-symbol {
            flex-grow: 1; /* Take remaining space */
        }

        .coin-name {
            font-size: 1.35em; /* Slightly larger name */
            font-weight: 600;
            color: #ffffff; /* White name */
            display: block; /* Ensure it takes full width */
        }

        .coin-symbol {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .coin-details {
           margin-bottom: 15px;
        }

        .coin-price-section {
            display: flex;
            justify-content: space-between; /* Push price and change apart */
            align-items: baseline; /* Align text nicely */
            margin-bottom: 10px;
        }

        .coin-price {
            font-size: 1.7em; /* Larger price */
            font-weight: 500;
            color: var(--text-color); /* Use default text color, change below */
            letter-spacing: 0.5px;
        }

        .price-change {
            font-size: 1.0em; /* Adjusted size */
            font-weight: 600;
            padding: 4px 8px; /* More padding */
            border-radius: 5px;
            color: #ffffff; /* White text always */
            text-align: right;
        }

        /* --- Dynamic Colors --- */
        .price-up {
            color: var(--green);
        }
        .price-down {
            color: var(--red);
        }
        .change-up {
            background-color: var(--green);
        }
        .change-down {
            background-color: var(--red);
        }
        .change-neutral {
            background-color: var(--text-secondary);
        }
        .arrow {
            display: inline-block;
            margin-right: 4px;
            font-size: 0.9em; /* Slightly smaller arrow */
        }

        /* --- Chart Styling --- */
        .chart-container {
            width: 100%;
            height: 180px; /* Taller chart */
            margin-top: auto; /* Pushes chart to bottom */
            opacity: 0.85; /* Slightly transparent chart */
            transition: opacity 0.3s ease;
        }
        .coin-card:hover .chart-container {
             opacity: 1; /* Full opacity on hover */
        }

         /* --- Footer/Info --- */
         .info {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 300;
         }
         .info a {
            color: var(--accent-color);
            text-decoration: none;
         }
         .info a:hover {
            text-decoration: underline;
         }
         .warning {
            color: #ffa000; /* Orange warning */
            font-weight: 500;
         }

    </style>
</head>
<body>

    <div class="container">
        <h1>Realtime Crypto Dashboard</h1>

        <div id="loading">Initializing Dashboard...</div>

        <div id="coin-list">
            <!-- Coin cards dynamically inserted -->
        </div>

        <div class="info">
             Real-time data stream via Firebase. Charts show session price movement.
            <br>
            <span class="warning">Security Alert:</span> Your Firebase rules appear public. Secure them in the Firebase Console to prevent unauthorized access.
            <br>
             Advanced charting & trading requires backend infrastructure and historical data.
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        // **CRITICAL**: SECURE YOUR FIREBASE RULES IN THE CONSOLE! PUBLIC RULES ARE DANGEROUS!
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg", // Use securely!
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.firebasestorage.app",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- Constants and State ---
        const MAX_CHART_POINTS = 45; // Show more points on the line chart
        const coinDataStore = {}; // { symbol: { currentData: {}, previousPrice: null, chart: null, chartData: { labels: [], prices: [] } } }
        const UI_ELEMENTS = {
             coinList: document.getElementById('coin-list'),
             loading: document.getElementById('loading'),
        };
        const CHART_COLORS = {
             green: 'rgba(8, 153, 129, 0.7)', // Chart green with opacity
             red: 'rgba(242, 54, 69, 0.7)',   // Chart red with opacity
             neutral: 'rgba(138, 142, 151, 0.7)', // Chart neutral with opacity
             border: 'rgba(209, 212, 220, 0.9)' // Lighter border for dark theme
        };

        // --- Initialize Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const tokensRef = database.ref('tokens');

             /**
             * Format number as USD currency with dynamic precision.
             */
            function formatCurrency(number) {
                if (typeof number !== 'number' || isNaN(number)) return '$--.--';
                const options = {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: number < 0.1 ? 4 : 2,
                    maximumFractionDigits: number < 0.001 ? 8 : (number < 1 ? 4 : 2)
                };
                return number.toLocaleString('en-US', options);
            }

            /**
             * Creates or updates a coin card in the DOM.
             */
            function renderCoinCard(symbol, coin) {
                let card = document.getElementById(`coin-${symbol}`);
                const storeEntry = coinDataStore[symbol] || {}; // Get existing or empty object
                const previousPrice = storeEntry.previousPrice;
                const currentPrice = coin.priceUSD;

                let priceChangePercent = 0;
                let priceClass = '';
                let changeClass = 'change-neutral';
                let arrow = '';
                let priceChangeText = '0.00%'; // Default neutral text

                if (typeof previousPrice === 'number' && typeof currentPrice === 'number' && previousPrice !== 0) {
                    const priceChange = currentPrice - previousPrice;
                    priceChangePercent = (priceChange / previousPrice) * 100;

                    if (priceChangePercent > 0.001) { // Threshold to avoid tiny fluctuations showing color
                        priceClass = 'price-up';
                        changeClass = 'change-up';
                        arrow = '<span class="arrow">▲</span>';
                        priceChangeText = `${arrow}${priceChangePercent.toFixed(2)}%`;
                    } else if (priceChangePercent < -0.001) {
                        priceClass = 'price-down';
                        changeClass = 'change-down';
                        arrow = '<span class="arrow">▼</span>';
                        priceChangeText = `${arrow}${Math.abs(priceChangePercent).toFixed(2)}%`;
                    }
                    // If between -0.001 and 0.001, it remains neutral
                }

                // Create card if it doesn't exist
                if (!card) {
                    card = document.createElement('div');
                    card.className = 'coin-card';
                    card.id = `coin-${symbol}`;
                    card.innerHTML = `
                        <div class="coin-header">
                            <img src="${coin.logoUrl || '?'}" alt="${coin.name || 'N/A'}" class="coin-logo" onerror="this.style.visibility='hidden'">
                            <div class="coin-name-symbol">
                                <span class="coin-name">${coin.name || 'Unknown Token'}</span>
                                <span class="coin-symbol">(${symbol})</span>
                            </div>
                        </div>
                        <div class="coin-details">
                            <div class="coin-price-section">
                                <span class="coin-price price-value"></span>
                                <span class="price-change change-value"></span>
                            </div>
                             <!-- Other details can go here -->
                        </div>
                        <div class="chart-container">
                            <canvas id="chart-${symbol}"></canvas>
                        </div>
                    `;
                    UI_ELEMENTS.coinList.appendChild(card);
                    // Initialize data store entry if new
                    coinDataStore[symbol] = {
                        ...storeEntry,
                        chartData: { labels: [], prices: [] }
                    };
                    initializeChart(symbol); // Create chart instance only once
                }

                // Update dynamic elements
                const priceElement = card.querySelector('.price-value');
                const changeElement = card.querySelector('.change-value');

                priceElement.textContent = formatCurrency(currentPrice);
                priceElement.className = `coin-price price-value ${priceClass}`; // Apply up/down class to price too

                changeElement.innerHTML = priceChangeText;
                changeElement.className = `price-change change-value ${changeClass}`;
                changeElement.style.display = (typeof previousPrice === 'number') ? 'inline-block' : 'none'; // Show only after first update


                // Update store
                coinDataStore[symbol] = {
                    ...coinDataStore[symbol], // Keep existing chart instance and data
                    currentData: coin,
                    previousPrice: currentPrice // Update previous price for next calculation
                };

                // Update the chart with the new price
                updateChart(symbol, currentPrice);
            }

            /**
             * Initializes a Chart.js instance for a coin.
             */
            function initializeChart(symbol) {
                const canvas = document.getElementById(`chart-${symbol}`);
                if (!canvas || !coinDataStore[symbol]) return; // Guard clause

                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Price',
                            data: [],
                            borderColor: CHART_COLORS.neutral, // Start neutral
                            borderWidth: 2,
                            fill: { // Gradient fill
                                target: 'origin',
                                above: 'rgba(8, 153, 129, 0.1)',   // Light green fill above origin
                                below: 'rgba(242, 54, 69, 0.1)'    // Light red fill below origin
                             },
                            tension: 0.3, // Smoother line
                            pointRadius: 0,
                            pointHoverRadius: 4, // Show point on hover
                            pointBackgroundColor: CHART_COLORS.border,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 300, easing: 'linear' },
                        scales: {
                            x: { display: false },
                            y: {
                                display: false, // Hide Y-axis for cleaner look in card
                                // Optionally configure ticks if you want to display it
                                // ticks: { ... }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                position: 'nearest',
                                displayColors: false, // Hide color box in tooltip
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { weight: 'bold' },
                                bodyFont: { size: 13 },
                                padding: 10,
                                callbacks: {
                                     title: (tooltipItems) => `Time: ${tooltipItems[0].label}`, // Show time label
                                     label: (context) => `Price: ${formatCurrency(context.parsed.y)}`
                                 }
                            }
                        },
                         interaction: { // Enhance hover effects
                             mode: 'index',
                             intersect: false,
                         },
                    }
                };

                 try {
                     // Destroy existing chart if somehow recreated
                     if (coinDataStore[symbol]?.chart) {
                          coinDataStore[symbol].chart.destroy();
                     }
                    coinDataStore[symbol].chart = new Chart(canvas.getContext('2d'), chartConfig);
                } catch (error) {
                     console.error(`Chart initialization error for ${symbol}:`, error);
                     canvas.parentElement.innerHTML = `<p style="color: ${CHART_COLORS.red}; font-size: 0.8em; text-align: center; margin-top: 20px;">Chart Error</p>`;
                }
            }

            /**
             * Updates the chart data and redraws.
             */
            function updateChart(symbol, newPrice) {
                const storeEntry = coinDataStore[symbol];
                if (!storeEntry?.chart || typeof newPrice !== 'number' || isNaN(newPrice)) return;

                const chart = storeEntry.chart;
                const chartData = storeEntry.chartData;
                const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                chartData.labels.push(currentTime);
                chartData.prices.push(newPrice);

                // Limit history
                while (chartData.labels.length > MAX_CHART_POINTS) {
                    chartData.labels.shift();
                    chartData.prices.shift();
                }

                // Update chart data
                chart.data.labels = chartData.labels;
                chart.data.datasets[0].data = chartData.prices;

                // Set dynamic border color based on start vs end price in current view
                 let borderColor = CHART_COLORS.neutral;
                 if (chartData.prices.length >= 2) {
                     const firstPrice = chartData.prices[0];
                     const lastPrice = chartData.prices[chartData.prices.length - 1];
                     if (lastPrice > firstPrice) borderColor = CHART_COLORS.green;
                     else if (lastPrice < firstPrice) borderColor = CHART_COLORS.red;
                 }
                 chart.data.datasets[0].borderColor = borderColor;


                // Update chart smoothly
                chart.update('none'); // 'none' for less jarring updates
            }

            // --- Firebase Listener ---
            tokensRef.on('value', (snapshot) => {
                UI_ELEMENTS.loading.style.display = 'none';
                const tokensData = snapshot.val();

                if (tokensData) {
                    const currentSymbols = Object.keys(tokensData);
                    const existingCardSymbols = Array.from(UI_ELEMENTS.coinList.children).map(card => card.id.replace('coin-', ''));

                    // Update or add cards
                    currentSymbols.forEach(symbol => {
                        const coin = tokensData[symbol];
                        if (coin && typeof coin.priceUSD === 'number' && coin.name) {
                             renderCoinCard(symbol, coin);
                         } else {
                             console.warn(`Invalid data for token ${symbol}:`, coin);
                              // Optionally remove/hide card with bad data
                              const badCard = document.getElementById(`coin-${symbol}`);
                              if(badCard) badCard.style.display = 'none';
                         }
                    });

                    // Remove cards for tokens no longer in Firebase
                    existingCardSymbols.forEach(symbol => {
                        if (!currentSymbols.includes(symbol)) {
                            const cardToRemove = document.getElementById(`coin-${symbol}`);
                            if (cardToRemove) {
                                if (coinDataStore[symbol]?.chart) {
                                    coinDataStore[symbol].chart.destroy(); // Clean up chart
                                }
                                delete coinDataStore[symbol]; // Remove from store
                                cardToRemove.remove();
                                console.log(`Removed stale card: ${symbol}`);
                            }
                        }
                    });

                } else {
                    UI_ELEMENTS.coinList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No token data found. Ensure Firebase path `/tokens` has data.</p>';
                    console.warn("No data received from Firebase path '/tokens'.");
                }
            }, (error) => {
                UI_ELEMENTS.loading.style.display = 'none';
                console.error("Firebase read failed:", error);
                UI_ELEMENTS.coinList.innerHTML = `<p style="color: ${CHART_COLORS.red}; text-align: center;">Error connecting to data source: ${error.message}</p>`;
            });

        } catch (error) {
            console.error("Initialization error:", error);
            UI_ELEMENTS.loading.style.display = 'none';
            UI_ELEMENTS.coinList.innerHTML = `<p style="color: ${CHART_COLORS.red}; text-align: center;">Critical script error: ${error.message}</p>`;
        }

    </script>

</body>
</html>
