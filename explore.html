<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Style Chart</title>
    <!-- TradingView Lightweight Charts Library -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #131722; /* TradingView dark background */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        #chart-container {
            width: 100%;
            height: 100%; /* Make chart fill the screen */
            position: relative;
        }
        #loading-chart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #d1d4dc;
            font-size: 1.5em;
            z-index: 10; /* Ensure it's above the chart initially */
        }
         .tv-lightweight-charts {
             /* Ensures chart div takes space immediately */
             display: block;
             width: 100%;
             height: 100%;
         }
         /* --- Firebase Status Indicator (Optional) --- */
         #firebase-status {
             position: fixed; /* Keep it fixed on screen */
             bottom: 10px;
             left: 10px;
             padding: 5px 10px;
             border-radius: 4px;
             font-size: 0.8em;
             z-index: 20;
             opacity: 0.8;
         }
         .status-connected {
             background-color: #089981; /* Green */
             color: white;
         }
         .status-disconnected {
             background-color: #f23645; /* Red */
             color: white;
         }
         .status-updating {
              background-color: #ff9800; /* Orange */
              color: black;
         }
    </style>
</head>
<body>
    <div id="loading-chart">Loading Chart Data...</div>
    <div id="chart-container"></div>
    <div id="firebase-status" class="status-disconnected">Connecting...</div>

    <script>
        // --- Firebase Configuration ---
        // **CRITICAL**: SECURE YOUR FIREBASE RULES IN THE CONSOLE!
        const firebaseConfig = {
            apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg", // Use securely!
            authDomain: "ab-studio-marketcap.firebaseapp.com",
            databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
            projectId: "ab-studio-marketcap",
            storageBucket: "ab-studio-marketcap.firebasestorage.app",
            messagingSenderId: "115268088088",
            appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
        };

        // --- Chart Setup ---
        const chartContainer = document.getElementById('chart-container');
        const loadingIndicator = document.getElementById('loading-chart');
        const firebaseStatusElement = document.getElementById('firebase-status');
        let chart = null;
        let candlestickSeries = null;
        let currentChartData = []; // Holds the current OHLCV data displayed

        // ** IMPORTANT: SAMPLE Historical Data (Replace with real data source if possible) **
        // Format: { time: 'YYYY-MM-DD' or UnixTimestamp, open: number, high: number, low: number, close: number }
        const sampleHistoricalData = [
             // Add A LOT more data here for a realistic chart
             { time: '2023-10-01', open: 0.0010, high: 0.0011, low: 0.0009, close: 0.00095 },
             { time: '2023-10-02', open: 0.00095, high: 0.00105, low: 0.00092, close: 0.00102 },
             { time: '2023-10-03', open: 0.00102, high: 0.00115, low: 0.00100, close: 0.0011 },
             { time: '2023-10-04', open: 0.0011, high: 0.00112, low: 0.00105, close: 0.00108 },
             { time: '2023-10-05', open: 0.00108, high: 0.00125, low: 0.00107, close: 0.0012 },
             { time: '2023-10-06', open: 0.0012, high: 0.00122, low: 0.00115, close: 0.00118 },
             { time: '2023-10-07', open: 0.00118, high: 0.00130, low: 0.00116, close: 0.00128 },
             { time: '2023-10-08', open: 0.00128, high: 0.00135, low: 0.00125, close: 0.00133 },
             { time: '2023-10-09', open: 0.00133, high: 0.00140, low: 0.00130, close: 0.00138 },
             { time: '2023-10-10', open: 0.00138, high: 0.00145, low: 0.00135, close: 0.00142 },
             // Add many more data points for a usable chart...
             // Let's add a point for "today" based on the last static point
             { time: '2023-10-11', open: 0.00142, high: 0.00142, low: 0.00142, close: 0.00142 } // Placeholder for today
         ];
        // Convert dates to Unix timestamps (seconds) for Lightweight Charts if needed, or use 'YYYY-MM-DD'
        // sampleHistoricalData = sampleHistoricalData.map(d => ({ ...d, time: new Date(d.time).getTime() / 1000 }));


        // --- Initialize Chart ---
        function initializeChart() {
            try {
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                    layout: {
                        backgroundColor: '#131722',
                        textColor: 'rgba(255, 255, 255, 0.9)',
                    },
                    grid: {
                        vertLines: { color: '#334158' },
                        horzLines: { color: '#334158' },
                    },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    priceScale: {
                        borderColor: '#485c7b',
                        autoScale: true, // Automatically adjust price scale
                         // More precise formatting for low-value tokens
                         formatter: price => {
                             if (price < 0.0001) return price.toFixed(8);
                             if (price < 0.01) return price.toFixed(6);
                             if (price < 1) return price.toFixed(4);
                             return price.toFixed(2);
                         },
                    },
                    timeScale: {
                        borderColor: '#485c7b',
                        timeVisible: true, // Show time on the bottom scale
                        secondsVisible: false, // Hide seconds for daily/hourly data usually
                    },
                });

                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#089981',   // TradingView Green
                    downColor: '#f23645', // TradingView Red
                    borderDownColor: '#f23645',
                    borderUpColor: '#089981',
                    wickDownColor: '#f23645',
                    wickUpColor: '#089981',
                });

                // Sort data just in case it's not
                 currentChartData = sampleHistoricalData.sort((a, b) => new Date(a.time) - new Date(b.time));
                 // Make sure time is in 'YYYY-MM-DD' format as Lightweight Charts handles it well
                 currentChartData = currentChartData.map(d => ({...d, time: d.time.split('T')[0]}));

                candlestickSeries.setData(currentChartData);

                loadingIndicator.style.display = 'none'; // Hide loading message

                // Make chart responsive
                window.addEventListener('resize', () => {
                    chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
                });

            } catch (error) {
                console.error("Chart initialization failed:", error);
                loadingIndicator.textContent = "Error loading chart.";
                loadingIndicator.style.color = "#f23645";
            }
        }

        // --- Firebase Integration ---
        function connectFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                // ** SPECIFY WHICH TOKEN TO TRACK **
                const tokenSymbol = 'ABS'; // Change this to the specific token you want to chart
                const tokenRef = database.ref(`tokens/${tokenSymbol}`);

                console.log(`Attempting to connect to Firebase for token: ${tokenSymbol}`);
                setFirebaseStatus('Connecting...', 'status-disconnected'); // Initial connecting state

                 // Monitor connection state
                 const connectedRef = database.ref(".info/connected");
                 connectedRef.on("value", (snap) => {
                   if (snap.val() === true) {
                     console.log("Firebase Connected.");
                     setFirebaseStatus(`Connected (${tokenSymbol})`, 'status-connected');
                   } else {
                     console.log("Firebase Disconnected.");
                     setFirebaseStatus('Disconnected', 'status-disconnected');
                   }
                 });


                tokenRef.on('value', (snapshot) => {
                    const tokenData = snapshot.val();

                    if (chart && candlestickSeries && tokenData && typeof tokenData.priceUSD === 'number') {
                        const newPrice = tokenData.priceUSD;
                        console.log(`Received price update for ${tokenSymbol}: ${newPrice}`);
                        setFirebaseStatus(`Updating ${tokenSymbol}: ${newPrice.toFixed(6)}`, 'status-updating'); // Show updating status

                        // --- Update the LAST candle ---
                        if (currentChartData.length > 0) {
                            let lastCandle = { ...currentChartData[currentChartData.length - 1] }; // Get a copy

                             // For a REAL system, you'd check if the current time falls
                             // into the *next* candle's interval. For this demo, we just
                             // update the existing last candle.

                            // Update close price
                            lastCandle.close = newPrice;

                            // Update high price if new price is higher
                            if (newPrice > lastCandle.high) {
                                lastCandle.high = newPrice;
                            }

                            // Update low price if new price is lower
                            if (newPrice < lastCandle.low) {
                                lastCandle.low = newPrice;
                            }

                            // Update the series with the modified last candle
                            candlestickSeries.update(lastCandle);

                            // Update our local store too (optional but good practice)
                            currentChartData[currentChartData.length - 1] = lastCandle;

                            // Briefly change status back to connected after update
                            setTimeout(() => setFirebaseStatus(`Connected (${tokenSymbol})`, 'status-connected'), 1000);


                        } else {
                             console.warn("Chart data is empty, cannot update last candle.");
                        }

                    } else if (tokenData === null) {
                         console.warn(`Token ${tokenSymbol} not found in Firebase.`);
                         setFirebaseStatus(`Error: ${tokenSymbol} not found`, 'status-disconnected');
                    }
                     else {
                        console.warn("Skipping update: Chart not ready or invalid token data received.", tokenData);
                     }
                }, (error) => {
                    console.error(`Firebase read failed for ${tokenSymbol}:`, error);
                    setFirebaseStatus(`Firebase Error`, 'status-disconnected');
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                setFirebaseStatus('Firebase Init Error', 'status-disconnected');
                 loadingIndicator.textContent = "Error connecting to data.";
                 loadingIndicator.style.color = "#f23645";
            }
        }

         // --- Helper Function for Status ---
         function setFirebaseStatus(message, className) {
             if (firebaseStatusElement) {
                 firebaseStatusElement.textContent = message;
                 firebaseStatusElement.className = ''; // Clear existing classes
                 firebaseStatusElement.classList.add('firebase-status', className);
             }
         }


        // --- Start ---
        initializeChart();
        // Connect to Firebase AFTER chart is initialized
        if (chart) {
             connectFirebase();
        } else {
             // Handle case where chart init failed before Firebase connection attempt
             setFirebaseStatus('Chart Init Failed', 'status-disconnected');
        }

    </script>
</body>
</html>
