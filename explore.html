<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Token Explorer - AB Wallet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Optional: Include tinycolor for advanced theme consistency -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> -->

    <style>
        :root {
            --bg-color: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --card-bg: #1e1e1e;
            --accent-color: #1DB954; /* Typically button color */
            --button-bg: #1DB954;
            --button-text: #ffffff;
            --input-bg: #282828;
            --border-color: #333333;
            --error-color: #f44336;   /* Red for down moves */
            --success-color: #4caf50; /* Green for up moves */
            --hover-bg: rgba(255, 255, 255, 0.05);
            --modal-bg: #2a2a2a;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --positive-change-color: var(--success-color);
            --negative-change-color: var(--error-color);
        }

        /* --- Base Styles (Adapted) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-color); color: var(--primary-text); overscroll-behavior: none; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }
        .app-container { flex-grow: 1; padding: 20px 15px; /* Consistent padding */ display: flex; flex-direction: column; overflow: hidden; /* Prevent body scroll */ }

        /* --- Header Area (Title, Search, Sort) --- */
        .explorer-header { margin-bottom: 15px; flex-shrink: 0; }
        h1 { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 20px; color: var(--primary-text); }
        .controls-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box {
            flex-grow: 1;
            padding: 10px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--primary-text);
            font-size: 15px;
            outline: none;
        }
        .search-box:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2); }
        .sort-select { /* Use a button that triggers a sort menu/cycle? Or select */
            padding: 10px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--primary-text);
            border-radius: 8px;
            cursor: pointer;
            appearance: none; /* Remove default arrow */
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23b3b3b3' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
             background-position: right 10px center;
            padding-right: 35px; /* Space for arrow */
            outline: none;
             min-width: 110px; /* Prevent squishing */
             text-align: center;
        }

        /* --- Loading/Error States --- */
        .status-indicator { text-align: center; padding: 40px 20px; color: var(--secondary-text); display: flex; justify-content: center; align-items: center; min-height: 150px; font-size: 16px;}
        .status-indicator.hidden { display: none; }
        .status-indicator svg { width: 24px; height: 24px; border: 4px solid rgba(255,255,255,0.2); border-radius: 50%; border-top-color: var(--primary-text); animation: spin 1s ease-in-out infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { color: var(--error-color); font-weight: 500; }

        /* --- Token List Styles --- */
        .list-scroll-container {
             flex-grow: 1; /* Take remaining vertical space */
             overflow-y: auto; /* Enable vertical scrolling ONLY here */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #tokenListContainer { /* This is now INSIDE scroll container */
             padding: 5px 0;
        }
        .token-list-item-explorer {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 20px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background-color 0.15s ease;
        }
        .token-list-item-explorer:last-child { border-bottom: none; }
        .token-list-item-explorer:hover { background-color: var(--hover-bg); }
        .token-list-item-explorer.hidden { display: none; } /* For filtering */

        .token-info-explorer { display: flex; align-items: center; gap: 15px; flex-shrink: 0; overflow: hidden; /* Prevent long names pushing content */ }
        .token-info-explorer img { width: 36px; height: 36px; border-radius: 50%; background-color: #333; border: 1px solid var(--border-color); flex-shrink: 0; }
        .token-name-symbol-explorer { line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .token-name-explorer { font-weight: 600; color: var(--primary-text); font-size: 15px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;}
        .token-symbol-explorer { font-size: 13px; color: var(--secondary-text); text-transform: uppercase; }

        .token-pricing-explorer { text-align: right; flex-shrink: 0; min-width: 90px; /* Prevent wrapping */}
        .token-price-explorer { font-weight: 600; color: var(--primary-text); font-size: 15px; margin-bottom: 3px; transition: color 0.3s ease; }
        .token-change-explorer {
            font-size: 13px; font-weight: 500;
            color: var(--secondary-text); /* Default/Neutral color */
            transition: color 0.3s ease; padding: 2px 5px; border-radius: 4px;
        }
        .token-change-explorer.positive { color: var(--positive-change-color); }
        .token-change-explorer.negative { color: var(--negative-change-color); }

         /* Flash effect (can be less intrusive) */
         @keyframes price-change-flash { 0% { opacity: 0.5; } 100% { opacity: 1; } }
         .price-flash { animation: price-change-flash 0.5s ease-out; }


        /* --- Token Detail Modal Styles (Mostly Unchanged) --- */
        .modal-overlay { /* ... keep existing styles ... */ }
        .token-detail-modal { /* ... keep existing styles ... */ }
        .modal-header { /* ... keep existing styles ... */ }
        .modal-content { /* ... keep existing styles ... */ }
        .token-stats { /* ... keep existing styles ... */ }
        .stat-item { /* ... keep existing styles ... */ }
        .stat-label { /* ... keep existing styles ... */ }
        .stat-value { /* ... keep existing styles ... */ }
        #candlestickChart { /* ... keep existing styles ... */ }
        .candle-body, .wick, .chart-no-data { /* ... keep existing styles ... */ }


    </style>
</head>
<body>

    <div class="app-container">

        <div class="explorer-header">
            <h1>Token Explorer</h1>
            <div class="controls-container">
                <input type="search" id="searchBox" class="search-box" placeholder="Search name or symbol...">
                <select id="sortSelect" class="sort-select">
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                    <option value="price_desc">Price High-Low</option>
                    <option value="price_asc">Price Low-High</option>
                    <option value="change_desc">Change High-Low</option>
                    <option value="change_asc">Change Low-High</option>
                </select>
            </div>
        </div>

        <!-- Status Indicator (Loading/Error) -->
        <div id="statusIndicator" class="status-indicator">
             <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" r="32" stroke-width="8" stroke="var(--accent-color)" stroke-dasharray="50.26548245743669 50.26548245743669" fill="none" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" keyTimes="0;1" values="0 50 50;360 50 50"></animateTransform></circle></svg>
            <span>Loading Tokens...</span>
        </div>

        <!-- Token List Scroll Container -->
        <div class="list-scroll-container" id="listScrollContainer">
             <div id="tokenListContainer">
                <!-- Token items populated by JS -->
            </div>
         </div>


    </div>

    <!-- Token Detail Modal (HTML unchanged) -->
    <div id="tokenDetailModalOverlay" class="modal-overlay">
         <!-- ... modal HTML structure ... -->
        <div id="tokenDetailModal" class="token-detail-modal">
            <div class="modal-header">
                <h3 id="modalTokenName"><img id="modalTokenLogo" src="" alt=""> <span>Token Details</span></h3>
                <button id="modalCloseBtn" class="modal-close-button" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-content">
                <div class="token-stats">
                    <div class="stat-item">
                        <span class="stat-label">Price</span>
                        <span class="stat-value" id="modalTokenPrice">$0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Change (Recent)</span>
                        <span class="stat-value" id="modalTokenChange">0.00%</span>
                    </div>
                     <!-- Optional: <div class="stat-item"><span class="stat-label">Market Cap</span><span class="stat-value" id="modalTokenMarketCap">$---</span></div> -->
                 </div>
                 <h4>Simplified Price Movement</h4>
                <div id="candlestickChart">
                     <span class="chart-no-data">Price history needed for chart.</span>
                 </div>
                 <p style="font-size: 11px; text-align: center; color: var(--secondary-text); margin-top: 10px;">Note: Chart shows a simplified view based on recent price change.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config (REPLACE WITH YOURS!) ---
       const firebaseConfig = {
  apiKey: "AIzaSyBW1WPXUN8DYhT6npZQYoQ3l4J-jFSbzfg",
  authDomain: "ab-studio-marketcap.firebaseapp.com",
  databaseURL: "https://ab-studio-marketcap-default-rtdb.firebaseio.com",
  projectId: "ab-studio-marketcap",
  storageBucket: "ab-studio-marketcap.firebasestorage.app",
  messagingSenderId: "115268088088",
  appId: "1:115268088088:web:65643a047f92bfaa66ee6d"
};
        // --- Global State ---
        let db = null;
        let tokenData = {};         // Current token data { symbol: { name, priceUSD, logoUrl, ..., _change?: number, _isPositive?: boolean } } - adding derived state
        let previousTokenData = {}; // Stores the data from the *last* firebase update for comparison
        let firebaseInitialized = false;
        let listenersAttached = false;
        let tg = null;
        let currentSort = 'name_asc';    // Default sort
        let currentSearchTerm = '';      // Default search
        let tokenListItemsCache = {};    // Cache DOM elements for faster updates: { symbol: element }

        // --- DOM Elements ---
        const statusIndicator = document.getElementById('statusIndicator');
        const listScrollContainer = document.getElementById('listScrollContainer');
        const tokenListContainer = document.getElementById('tokenListContainer');
        const searchBox = document.getElementById('searchBox');
        const sortSelect = document.getElementById('sortSelect');
        // Modal elements (assuming IDs are correct)
        const modalOverlay = document.getElementById('tokenDetailModalOverlay');
        const modal = document.getElementById('tokenDetailModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTokenName = document.getElementById('modalTokenName');
        const modalTokenLogo = document.getElementById('modalTokenLogo');
        const modalTokenPrice = document.getElementById('modalTokenPrice');
        const modalTokenChange = document.getElementById('modalTokenChange');
        const candlestickChartContainer = document.getElementById('candlestickChart');

        // --- Utility Functions ---
        function setStatus(type, message) { // 'loading', 'error', 'hidden'
            if (!statusIndicator) return;
            const svgIcon = statusIndicator.querySelector('svg');
            const spanText = statusIndicator.querySelector('span');

            if (type === 'hidden') {
                 statusIndicator.classList.add('hidden');
                 listScrollContainer.style.display = 'block'; // Show list when hidden
                 return;
             }

            statusIndicator.classList.remove('hidden');
             listScrollContainer.style.display = 'none'; // Hide list container when showing status
             spanText.textContent = message;
             spanText.classList.remove('error-message');
             svgIcon.style.display = 'none';

            if (type === 'loading') {
                 svgIcon.style.display = 'inline-block';
             } else if (type === 'error') {
                 spanText.classList.add('error-message');
             }
         }
         function formatCurrency(amount, decimals = 2) { /* ... keep existing improved version ... */ const num = parseFloat(amount); if (isNaN(num)) return '0.00'; const effectiveDecimals = (num > 0 && num < 0.01) ? 6 : (num > 0 && num < 1) ? 4 : decimals; return num.toLocaleString(undefined, { minimumFractionDigits: effectiveDecimals, maximumFractionDigits: effectiveDecimals }); }
        function formatPercentage(change) { /* ... keep existing ... */ const num = parseFloat(change); return isNaN(num) ? '0.00%' : `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`; }
         const applyTheme = (params) => { /* ... keep existing comprehensive version ... */ if (!params) return; const root = document.documentElement; const setProp = (prop, value) => root.style.setProperty(prop, value); try {const bgColor=params.bg_color||'#121212';const textColor=params.text_color||'#ffffff';const hintColor=params.hint_color||'#b3b3b3';const buttonColor=params.button_color||'#1DB954';const secondaryBgColor=params.secondary_bg_color||'#1e1e1e'; /* Assume tinycolor exists or use fallback */ const t_bgColor=tinycolor(bgColor);const t_textColor=tinycolor(textColor);const t_secondaryBgColor=tinycolor(secondaryBgColor); setProp('--bg-color',bgColor);setProp('--primary-text',textColor);setProp('--secondary-text',hintColor);setProp('--accent-color',buttonColor);setProp('--button-bg',buttonColor);setProp('--card-bg',secondaryBgColor);setProp('--input-bg',t_secondaryBgColor.darken(5).toString()); setProp('--border-color',t_secondaryBgColor.lighten(10).toString());setProp('--hover-bg',t_textColor.setAlpha(0.05).toString());setProp('--error-color','#f44336');setProp('--success-color','#4caf50');setProp('--positive-change-color',t_bgColor.isDark()?'#4caf50':'#2e7d32');setProp('--negative-change-color',t_bgColor.isDark()?'#f44336':'#c62828');setProp('--modal-bg',t_secondaryBgColor.lighten(3).toString());setProp('--modal-overlay-bg',t_bgColor.setAlpha(0.7).toString());document.body.style.backgroundColor=bgColor;document.body.style.color=textColor;if(tg&&tg.setHeaderColor)try{tg.setHeaderColor(secondaryBgColor);}catch(e){} if(tg&&tg.setBackgroundColor)try{tg.setBackgroundColor(bgColor);}catch(e){}}catch(e){console.error("Theme err",e)} };


        // --- Firebase Functions ---
        function initializeFirebase() { /* ... keep existing identical version ... */ return new Promise((resolve, reject) => { if (firebaseInitialized) { resolve(); return; } try { if (typeof firebase === 'undefined') { throw new Error("Firebase SDK not loaded"); } if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase Initialized"); } else { firebase.app(); console.log("Firebase Re-using existing app instance."); } db = firebase.database(); firebaseInitialized = true; resolve(); } catch (error) { console.error("Firebase Init Error:", error); setStatus('error', `DB Init failed: ${error.message}`); reject(error); } }); }

        // --- Real-time Listener for Token Data ---
        function listenForTokenData() {
            if (!db) { setStatus('error', "Database not initialized."); return; }
            const tokensRef = db.ref('tokens');
             console.log("Setting up Firebase listener: /tokens");

            tokensRef.on('value', (snapshot) => {
                const newTokensRaw = snapshot.val() || {};
                 // console.log(`Received raw data: ${Object.keys(newTokensRaw).length} tokens`);

                 const newTokensProcessed = {};
                // Pre-process data and calculate change vs previous state
                for (const symbol in newTokensRaw) {
                     if (typeof newTokensRaw[symbol] === 'object' && newTokensRaw[symbol] !== null && newTokensRaw[symbol].priceUSD != null) {
                         const currentPrice = parseFloat(newTokensRaw[symbol].priceUSD);
                         if (isNaN(currentPrice) || currentPrice < 0) continue; // Skip invalid prices

                         const prevInfo = tokenData[symbol]; // Use current global state as previous for comparison
                         const prevPrice = prevInfo ? prevInfo.priceUSD : null;
                         let changePercent = 0;
                         let isPositive = null; // null = neutral/no change

                         if (prevPrice !== null && prevPrice > 0 && currentPrice !== null) {
                             const priceChange = currentPrice - prevPrice;
                             if (Math.abs(priceChange) > 1e-9) { // Avoid division by zero and check significant change
                                 changePercent = (priceChange / prevPrice) * 100;
                                if (priceChange > 1e-9) isPositive = true;
                                 else if (priceChange < -1e-9) isPositive = false;
                             }
                         }

                        newTokensProcessed[symbol] = {
                            name: newTokensRaw[symbol].name || symbol,
                            priceUSD: currentPrice,
                            logoUrl: newTokensRaw[symbol].logoUrl || `https://via.placeholder.com/36/333333/ffffff?text=${symbol.substring(0,1)}`,
                             addedAt: newTokensRaw[symbol].addedAt, // Include addedAt if available
                             // Store calculated change *in* the token data object for easy access during sorting/rendering
                            _changePercent: changePercent, // Derived state
                            _isPositive: isPositive      // Derived state
                        };
                    }
                }
                 if (newTokensProcessed.USDT) newTokensProcessed.USDT.priceUSD = 1.00; // Force USDT

                 // Update global state
                 previousTokenData = { ...tokenData }; // Keep previous raw prices if needed elsewhere, though derived state is now in tokenData
                 tokenData = newTokensProcessed;

                // Update UI (sort, filter, render)
                updateTokenExplorerList();

             }, (error) => {
                console.error("Firebase Listener Error:", error);
                setStatus('error', `DB connection error: ${error.message}`);
                // Potentially clear list or show stale data message
             });
        }


        // --- Core UI Update/Render Function ---
        function updateTokenExplorerList() {
             if (!tokenListContainer || typeof tokenData !== 'object') return;
             // console.log(`Updating list. Sort: ${currentSort}, Filter: '${currentSearchTerm}'`); // Debug

             setStatus('hidden'); // Hide loading/error when updating list

             const searchTermLower = currentSearchTerm.toLowerCase();

             // 1. Filter Data
             const filteredTokens = Object.entries(tokenData)
                 .map(([symbol, data]) => ({ symbol, ...data })) // Convert to array
                 .filter(token => {
                     if (!token.name || token.priceUSD == null) return false; // Ensure basic data exists
                     if (!searchTermLower) return true; // No filter applied
                     return token.symbol.toLowerCase().includes(searchTermLower) ||
                            token.name.toLowerCase().includes(searchTermLower);
                 });

             // 2. Sort Data
            filteredTokens.sort((a, b) => {
                switch (currentSort) {
                     case 'name_asc': return (a.name || a.symbol).localeCompare(b.name || b.symbol);
                    case 'name_desc': return (b.name || b.symbol).localeCompare(a.name || a.symbol);
                     case 'price_asc': return (a.priceUSD || 0) - (b.priceUSD || 0);
                    case 'price_desc': return (b.priceUSD || 0) - (a.priceUSD || 0);
                     case 'change_asc': return (a._changePercent || 0) - (b._changePercent || 0);
                    case 'change_desc': return (b._changePercent || 0) - (a._changePercent || 0);
                    default: return 0;
                 }
            });

             // 3. Efficiently Render/Update DOM
             const fragment = document.createDocumentFragment();
             const existingSymbols = new Set(Object.keys(tokenListItemsCache));
             const currentSymbols = new Set();

             if (filteredTokens.length === 0) {
                 tokenListContainer.innerHTML = `<p style='color: var(--secondary-text); text-align: center; padding: 30px;'>No tokens match your criteria.</p>`;
                tokenListItemsCache = {}; // Clear cache if list is empty
                 return;
             }

            filteredTokens.forEach(token => {
                const symbol = token.symbol;
                 currentSymbols.add(symbol);
                 const currentPrice = token.priceUSD;
                 const changePercent = token._changePercent;
                 const isPositive = token._isPositive;

                 let listItem = tokenListItemsCache[symbol];
                 let priceFlashClass = '';

                // Check if price actually changed compared to previous *rendered* state if element exists
                if(listItem) {
                    const oldPriceText = listItem.querySelector('.token-price-explorer')?.textContent;
                     if (oldPriceText && oldPriceText !== `$${formatCurrency(currentPrice)}`) {
                        priceFlashClass = 'price-flash'; // Trigger flash if text content changed
                    }
                }


                 if (!listItem) {
                     // --- Create New List Item ---
                     listItem = document.createElement('div');
                     listItem.className = 'token-list-item-explorer';
                     listItem.dataset.symbol = symbol;

                    listItem.innerHTML = `
                        <div class="token-info-explorer">
                            <img src="${token.logoUrl}" alt="${symbol}" class="token-logo" onerror="this.src='https://via.placeholder.com/36/333333/ffffff?text=${symbol.substring(0,1)}'; this.onerror=null;">
                            <div class="token-name-symbol-explorer">
                                <div class="token-name-explorer">${token.name}</div>
                                <div class="token-symbol-explorer">${symbol}</div>
                            </div>
                        </div>
                        <div class="token-pricing-explorer">
                             <div class="token-price-explorer">${formatCurrency(currentPrice)}</div>
                             <div class="token-change-explorer">${formatPercentage(changePercent)}</div>
                        </div>
                    `;
                    listItem.addEventListener('click', () => showTokenDetailModal(symbol));
                    tokenListItemsCache[symbol] = listItem;

                 } else {
                      // --- Update Existing List Item (More Efficient) ---
                     // Update Price
                      const priceEl = listItem.querySelector('.token-price-explorer');
                      if (priceEl) priceEl.textContent = `$${formatCurrency(currentPrice)}`;

                     // Update Change %
                     const changeEl = listItem.querySelector('.token-change-explorer');
                      if (changeEl) {
                          changeEl.textContent = formatPercentage(changePercent);
                          changeEl.className = `token-change-explorer ${isPositive === true ? 'positive' : isPositive === false ? 'negative' : ''}`;
                      }

                      // Update Logo/Name only if necessary (less frequent changes)
                      const logoEl = listItem.querySelector('.token-logo');
                      if(logoEl && logoEl.src !== token.logoUrl) logoEl.src = token.logoUrl;
                      const nameEl = listItem.querySelector('.token-name-explorer');
                       if(nameEl && nameEl.textContent !== token.name) nameEl.textContent = token.name;

                 }

                 // Apply flash class if needed (do this *after* potentially updating text content)
                 const priceElForFlash = listItem.querySelector('.token-price-explorer');
                 if (priceElForFlash) {
                      priceElForFlash.classList.remove('price-flash'); // Remove old flash
                     if (priceFlashClass) {
                          // Trigger reflow before adding class again if needed
                          // void priceElForFlash.offsetWidth;
                         priceElForFlash.classList.add(priceFlashClass);
                      }
                  }

                 fragment.appendChild(listItem); // Add updated/new item to fragment
             });

            // Remove items that are no longer in the filtered/sorted list
             existingSymbols.forEach(symbol => {
                 if (!currentSymbols.has(symbol)) {
                    if (tokenListItemsCache[symbol]) {
                         // tokenListItemsCache[symbol].remove(); // Direct remove ok, or hide first?
                        delete tokenListItemsCache[symbol];
                     }
                 }
             });

             tokenListContainer.innerHTML = ''; // Clear container only once
             tokenListContainer.appendChild(fragment); // Append all changes at once

         }


        // --- Modal Functions (Simplified Chart Draw) ---
        function showTokenDetailModal(symbol) { /* ... keep existing, uses derived state now ... */ const currentInfo = tokenData[symbol]; const previousInfo = previousTokenData[symbol]; /* needed for simple candle */ if (!currentInfo) return; modalTokenName.querySelector('span').textContent=`${currentInfo.name} (${symbol})`; modalTokenLogo.src = currentInfo.logoUrl; modalTokenLogo.alt=symbol; modalTokenLogo.onerror=function(){this.src=`https://via.placeholder.com/24/333333/ffffff?text=${symbol.substring(0,1)}`}; modalTokenPrice.textContent=`$${formatCurrency(currentInfo.priceUSD)}`; const changePercent=currentInfo._changePercent; const isPositive=currentInfo._isPositive; modalTokenChange.textContent=formatPercentage(changePercent); modalTokenChange.className=`stat-value ${isPositive===true?'positive':isPositive===false?'negative':''}`; /* Optional: Market Cap: modalTokenMarketCap.textContent = currentInfo.marketCap ? `$${formatCurrency(currentInfo.marketCap, 0)}` : '$---'; */ drawSimpleCandlestick(currentInfo, previousInfo); modalOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
         function closeTokenDetailModal() { /* ... keep existing ... */ modalOverlay.classList.remove('active'); document.body.style.overflow = ''; }
         function drawSimpleCandlestick(current, previous) { /* ... keep existing - It remains simplified ... */ candlestickChartContainer.innerHTML=''; const currentPrice=current.priceUSD; const prevPrice=previous?previous.priceUSD:null; if(prevPrice===null||currentPrice===null||currentPrice<=0||prevPrice<=0){candlestickChartContainer.innerHTML='<span class="chart-no-data">Recent price data unavailable for chart.</span>'; return;} const openPrice=prevPrice; const closePrice=currentPrice; const highPrice=Math.max(openPrice,closePrice)*1.01; const lowPrice=Math.min(openPrice,closePrice)*0.99; const isPositive=closePrice>=openPrice; const candleClass=isPositive?'positive':'negative'; const svgNS="http://www.w3.org/2000/svg"; const svg=document.createElementNS(svgNS,"svg"); const priceRange=highPrice-lowPrice; const minY=lowPrice-(priceRange*0.1); const maxY=highPrice+(priceRange*0.1); const viewHeight=Math.max(1, maxY-minY); /* Ensure height > 0 */ svg.setAttribute("viewBox",`0 ${minY} 100 ${viewHeight}`); svg.setAttribute("preserveAspectRatio","xMidYMid meet"); const wick=document.createElementNS(svgNS,"line"); wick.setAttribute("x1","50"); wick.setAttribute("y1",lowPrice); wick.setAttribute("x2","50"); wick.setAttribute("y2",highPrice); wick.setAttribute("class",`wick ${candleClass}`); wick.setAttribute("stroke-width", Math.max(0.5, viewHeight * 0.015)); /* Dynamic stroke width */ svg.appendChild(wick); const body=document.createElementNS(svgNS,"rect"); body.setAttribute("x","30"); body.setAttribute("width","40"); body.setAttribute("y",Math.min(openPrice,closePrice)); body.setAttribute("height",Math.max(0.1, Math.abs(openPrice-closePrice))); body.setAttribute("class",`candle-body ${candleClass}`); body.setAttribute("stroke","none"); svg.appendChild(body); candlestickChartContainer.appendChild(svg); }


        // --- Event Listener Setup ---
        function setupEventListeners() {
             if (listenersAttached) return;
            console.log("Setting up Explorer listeners...");

             // Search Input
             searchBox.addEventListener('input', () => {
                 currentSearchTerm = searchBox.value;
                 updateTokenExplorerList(); // Re-render list with search filter
             });

             // Sort Select
             sortSelect.addEventListener('change', () => {
                 currentSort = sortSelect.value;
                 updateTokenExplorerList(); // Re-render list with new sort order
             });

             // Modal Close listeners (delegation happens inside update function for list items)
            modalCloseBtn.addEventListener('click', closeTokenDetailModal);
            modalOverlay.addEventListener('click', (event) => { if (event.target === modalOverlay) closeTokenDetailModal(); });

             listenersAttached = true;
         }

        // --- INITIALIZATION ---
        async function initializeApp() {
            console.log("--- Initializing Token Explorer ---");
             setStatus('loading', 'Initializing...'); // Show loading state

             // Check Placeholders
             if (firebaseConfig.apiKey === "YOUR_API_KEY") { setStatus('error', "CRITICAL: Firebase config missing!"); return; }

             // 1. Check Telegram Env
             if (typeof window.Telegram === 'undefined' || !window.Telegram.WebApp) { setStatus('error', "Telegram environment not detected."); return; }
            tg = window.Telegram.WebApp;

             try {
                // 2. Telegram Ready & Theme
                 await new Promise(resolve => tg.ready(resolve));
                 console.log("Telegram SDK Ready.");
                 tg.expand();
                 applyTheme(tg.themeParams);
                 if (tg.MainButton) tg.MainButton.hide();

                 // 3. Initialize Firebase
                 await initializeFirebase();
                 if (!db) throw new Error("Database connection failed.");

                // 4. Start Real-time Listener
                 setStatus('loading', 'Connecting to price feed...');
                 listenForTokenData(); // This now handles setting initial status too

                 // 5. Setup Interaction Listeners (Search, Sort, Modal)
                 setupEventListeners(); // Setup after core structure exists

                 console.log("--- Explorer Initialization Sequence Started ---");
                // Loading status handled by listener/update function

             } catch (error) {
                console.error("Explorer Initialization Failed:", error);
                 setStatus('error', `Initialization failed: ${error.message}`);
             }
        }

        // --- Start the app ---
         document.addEventListener('DOMContentLoaded', initializeApp);

     </script>

</body>
</html>
